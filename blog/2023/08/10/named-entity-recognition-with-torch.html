
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
        <meta name="description" content="Personal Website">
      
      
        <meta name="author" content="Andrey Shtrauss">
      
      
        <link rel="canonical" href="https://shtrausslearning.github.io/blog/2023/08/10/named-entity-recognition-with-torch.html">
      
      
      
        <link rel="next" href="../19/named-entity-recognition-with-huggingface-trainer.html">
      
      
      <link rel="icon" href="../../../../images/home-logo.svg">
      <meta name="generator" content="mkdocs-1.5.3, mkdocs-material-9.5.17">
    
    
      
        <title>Named Entity Recognition with Torch - mldsai</title>
      
    
    
      <link rel="stylesheet" href="../../../../assets/stylesheets/main.bcfcd587.min.css">
      
        
        <link rel="stylesheet" href="../../../../assets/stylesheets/palette.06af60db.min.css">
      
      


    
    
      
        <script src="https://unpkg.com/iframe-worker/shim"></script>
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Ubuntu:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Ubuntu";--md-code-font:"Roboto Mono"}</style>
      
    
    
      <link rel="stylesheet" href="../../../../stylesheets/customize.css">
    
      <link rel="stylesheet" href="../../../../stylesheets/extra.css">
    
      <link rel="stylesheet" href="../../../../stylesheets/simpleicons.css">
    
      <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.16.7/katex.min.css">
    
    <script>__md_scope=new URL("../../../..",location),__md_hash=e=>[...e].reduce((e,_)=>(e<<5)-e+_.charCodeAt(0),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      
  


  
  

<script id="__analytics">function __md_analytics(){function n(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],n("js",new Date),n("config","G-R7CLKWM3LT"),document.addEventListener("DOMContentLoaded",function(){document.forms.search&&document.forms.search.query.addEventListener("blur",function(){this.value&&n("event","search",{search_term:this.value})}),document$.subscribe(function(){var a=document.forms.feedback;if(void 0!==a)for(var e of a.querySelectorAll("[type=submit]"))e.addEventListener("click",function(e){e.preventDefault();var t=document.location.pathname,e=this.getAttribute("data-md-value");n("event","feedback",{page:t,data:e}),a.firstElementChild.disabled=!0;e=a.querySelector(".md-feedback__note [data-md-value='"+e+"']");e&&(e.hidden=!1)}),a.hidden=!1}),location$.subscribe(function(e){n("config","G-R7CLKWM3LT",{page_path:e.pathname})})});var e=document.createElement("script");e.async=!0,e.src="https://www.googletagmanager.com/gtag/js?id=G-R7CLKWM3LT",document.getElementById("__analytics").insertAdjacentElement("afterEnd",e)}</script>
  
    <script>"undefined"!=typeof __md_analytics&&__md_analytics()</script>
  

    
    
    
  </head>
  
  
    
    
      
    
    
    
    
    <body dir="ltr" data-md-color-scheme="slate" data-md-color-primary="custom" data-md-color-accent="custom">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#named-entity-recognition-with-torch-loop" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

<header class="md-header" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../../../../index.html" title="mldsai" class="md-header__button md-logo" aria-label="mldsai" data-md-component="logo">
      
  <img src="../../../../images/home-logo.svg" alt="logo">

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2Z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            mldsai
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Named Entity Recognition with Torch
            
          </span>
        </div>
      </div>
    </div>
    
      
        <form class="md-header__option" data-md-component="palette">
  
    
    
    
    <input class="md-option" data-md-color-media="" data-md-color-scheme="slate" data-md-color-primary="custom" data-md-color-accent="custom"  aria-hidden="true"  type="radio" name="__palette" id="__palette_0">
    
  
</form>
      
    
    
      <script>var media,input,key,value,palette=__md_get("__palette");if(palette&&palette.color){"(prefers-color-scheme)"===palette.color.media&&(media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']"),palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent"));for([key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
    
    
    
      <label class="md-header__button md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
      </label>
      <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41Z"/></svg>
        </button>
      </nav>
      
        <div class="md-search__suggest" data-md-component="search-suggest"></div>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
      <div class="md-header__source">
        <a href="https://github.com/shtrausslearning/shtrausslearning.github.io" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.5.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2023 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    shtrausslearning.github.io
  </div>
</a>
      </div>
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
            
<nav class="md-tabs" aria-label="Tabs" data-md-component="tabs">
  <div class="md-grid">
    <ul class="md-tabs__list">
      
        
  
  
  
    <li class="md-tabs__item">
      <a href="../../../../index.html" class="md-tabs__link">
        
  
    
  
  <b>Home</b>

      </a>
    </li>
  

      
        
  
  
  
    <li class="md-tabs__item">
      <a href="../../../../index.html#featured_work" class="md-tabs__link">
        
  
    
  
  <b>Featured</b>

      </a>
    </li>
  

      
        
  
  
  
    <li class="md-tabs__item">
      <a href="../../../../index.html#portfolio" class="md-tabs__link">
        
  
    
  
  <b>Latest</b>

      </a>
    </li>
  

      
        
  
  
    
  
  
    
    
      <li class="md-tabs__item md-tabs__item--active">
        <a href="../../../index.html" class="md-tabs__link">
          
  
    
  
  <b>Blog</b>

        </a>
      </li>
    
  

      
    </ul>
  </div>
</nav>
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
                
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" hidden>
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


  


<nav class="md-nav md-nav--primary md-nav--lifted" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../../../../index.html" title="mldsai" class="md-nav__button md-logo" aria-label="mldsai" data-md-component="logo">
      
  <img src="../../../../images/home-logo.svg" alt="logo">

    </a>
    mldsai
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/shtrausslearning/shtrausslearning.github.io" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.5.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2023 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    shtrausslearning.github.io
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../index.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    <b>Home</b>
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../index.html#featured_work" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    <b>Featured</b>
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../index.html#portfolio" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    <b>Latest</b>
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
    
  
  
  
    
    
      
        
          
        
      
        
      
        
      
    
    
      
        
        
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--section md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_4" checked>
        
          
          
          <div class="md-nav__link md-nav__container">
            <a href="../../../index.html" class="md-nav__link ">
              
  
  <span class="md-ellipsis">
    <b>Blog</b>
  </span>
  

            </a>
            
              
              <label class="md-nav__link " for="__nav_4" id="__nav_4_label" tabindex="">
                <span class="md-nav__icon md-icon"></span>
              </label>
            
          </div>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_4_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_4">
            <span class="md-nav__icon md-icon"></span>
            <b>Blog</b>
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
            
              
                
  
  
  
  
    
    
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
    
    
      
      
        
          
          
        
      
    
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_4_2" >
        
          
          <label class="md-nav__link" for="__nav_4_2" id="__nav_4_2_label" tabindex="">
            
  
  <span class="md-ellipsis">
    Archive
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_4_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_4_2">
            <span class="md-nav__icon md-icon"></span>
            Archive
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../../../archive/2025/07.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    July, 2025
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../../../archive/2025/02.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    February, 2025
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../../../archive/2024/10.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    October, 2024
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../../../archive/2024/04.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    April, 2024
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../../../archive/2024/03.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    March, 2024
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../../../archive/2023/12.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    December, 2023
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../../../archive/2023/11.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    November, 2023
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../../../archive/2023/10.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    October, 2023
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../../../archive/2023/09.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    September, 2023
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../../../archive/2023/08.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    August, 2023
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
    
    
      
      
        
          
          
        
      
    
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_4_3" >
        
          
          <label class="md-nav__link" for="__nav_4_3" id="__nav_4_3_label" tabindex="">
            
  
  <span class="md-ellipsis">
    Categories
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_4_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_4_3">
            <span class="md-nav__icon md-icon"></span>
            Categories
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../../../category/recsys.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Recsys
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../../../category/code-model.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    code model
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../../../category/eda.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    eda
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../../../category/internship.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    internship
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../../../category/nlp.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    nlp
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../../../category/pyspark.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    pyspark
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../../../category/science.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    science
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../../../category/sql.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    sql
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../../../category/uplift-modeling.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    uplift modeling
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
                
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#background" class="md-nav__link">
    <span class="md-ellipsis">
      Background
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Background">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#what-is-ner" class="md-nav__link">
    <span class="md-ellipsis">
      What is NER?
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#applications" class="md-nav__link">
    <span class="md-ellipsis">
      Applications
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#the-dataset" class="md-nav__link">
    <span class="md-ellipsis">
      The Dataset
    </span>
  </a>
  
    <nav class="md-nav" aria-label="The Dataset">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#massive-11" class="md-nav__link">
    <span class="md-ellipsis">
      Massive 1.1
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#relevant-columns" class="md-nav__link">
    <span class="md-ellipsis">
      Relevant Columns
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#text-preprocessing" class="md-nav__link">
    <span class="md-ellipsis">
      Text Preprocessing
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Text Preprocessing">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#define-tokeniser-model" class="md-nav__link">
    <span class="md-ellipsis">
      Define Tokeniser &amp; Model
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ner-format" class="md-nav__link">
    <span class="md-ellipsis">
      NER format
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#create-dataset" class="md-nav__link">
    <span class="md-ellipsis">
      Create Dataset
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#bert-multiclass-classifier" class="md-nav__link">
    <span class="md-ellipsis">
      BERT Multiclass Classifier
    </span>
  </a>
  
    <nav class="md-nav" aria-label="BERT Multiclass Classifier">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#model-architecture" class="md-nav__link">
    <span class="md-ellipsis">
      Model Architecture
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#model-additions" class="md-nav__link">
    <span class="md-ellipsis">
      Model Additions
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#train-model" class="md-nav__link">
    <span class="md-ellipsis">
      Train Model
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#save-model" class="md-nav__link">
    <span class="md-ellipsis">
      Save Model
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#using-our-ner-tagger" class="md-nav__link">
    <span class="md-ellipsis">
      Using our NER tagger
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Using our NER tagger">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#loading-model" class="md-nav__link">
    <span class="md-ellipsis">
      Loading Model
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#finding-ner-tags-in-a-document" class="md-nav__link">
    <span class="md-ellipsis">
      Finding NER tags in a document
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Finding NER tags in a document">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#references" class="md-nav__link">
    <span class="md-ellipsis">
      REFERENCES
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
  <div class="md-content md-content--post" data-md-component="content">
    <div class="md-sidebar md-sidebar--post" data-md-component="sidebar" data-md-type="navigation">
      <div class="md-sidebar__scrollwrap">
        <div class="md-sidebar__inner md-post">
          <nav class="md-nav md-nav--primary">
            <div class="md-post__back">
              <div class="md-nav__title md-nav__container">
                <a href="../../../index.html" class="md-nav__link">
                  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg>
                  <span class="md-ellipsis">
                    Back to index
                  </span>
                </a>
              </div>
            </div>
            
              <div class="md-post__authors md-typeset">
                
                  <div class="md-profile md-post__profile">
                    <span class="md-author md-author--long">
                      <img src="https://avatars.githubusercontent.com/u/79809117?v=4" alt="Andrey Shtrauss">
                    </span>
                    <span class="md-profile__description">
                      <strong>
                        
                          Andrey Shtrauss
                        
                      </strong>
                      <br>
                      Creator
                    </span>
                  </div>
                
              </div>
            
            <ul class="md-post__meta md-nav__list">
              <li class="md-nav__item md-nav__item--section">
                <div class="md-post__title">
                  <span class="md-ellipsis">
                    Metadata
                  </span>
                </div>
                <nav class="md-nav">
                  <ul class="md-nav__list">
                    <li class="md-nav__item">
                      <div class="md-nav__link">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 19H5V8h14m-3-7v2H8V1H6v2H5c-1.11 0-2 .89-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V5a2 2 0 0 0-2-2h-1V1m-1 11h-5v5h5v-5Z"/></svg>
                        <time datetime="2023-08-10 00:00:00" class="md-ellipsis">August 10, 2023</time>
                      </div>
                    </li>
                    
                    
                      <li class="md-nav__item">
                        <div class="md-nav__link">
                          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9 3v15h3V3H9m3 2 4 13 3-1-4-13-3 1M5 5v13h3V5H5M3 19v2h18v-2H3Z"/></svg>
                          <span class="md-ellipsis">
                            in
                            
                              <a href="../../../category/nlp.html">nlp</a></span>
                        </div>
                      </li>
                    
                    
                      
                      <li class="md-nav__item">
                        <div class="md-nav__link">
                          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 20a8 8 0 0 0 8-8 8 8 0 0 0-8-8 8 8 0 0 0-8 8 8 8 0 0 0 8 8m0-18a10 10 0 0 1 10 10 10 10 0 0 1-10 10C6.47 22 2 17.5 2 12A10 10 0 0 1 12 2m.5 5v5.25l4.5 2.67-.75 1.23L11 13V7h1.5Z"/></svg>
                          <span class="md-ellipsis">
                            
                              16 min read
                            
                          </span>
                        </div>
                      </li>
                    
                  </ul>
                </nav>
              </li>
            </ul>
          </nav>
          
        </div>
      </div>
    </div>
    <article class="md-content__inner md-typeset">
      
        
  
  

<nav class="md-tags" >
  
    
    
    
      <span class="md-tag">huggingface</span>
    
  
    
    
    
      <span class="md-tag">pytorch</span>
    
  
    
    
    
      <span class="md-tag">ner</span>
    
  
</nav>


  
  


<h1 id="named-entity-recognition-with-torch-loop"><strong>Named Entity Recognition with Torch Loop</strong><a class="headerlink" href="#named-entity-recognition-with-torch-loop" title="Permanent link">&para;</a></h1>
<p>In this notebook, we'll take a look at how we can utilise <code>HuggingFace</code> to easily load and use <code>BERT</code> for token classification. Whilst we are loading both the base model &amp; tokeniser from <code>HuggingFace</code>, we'll be using a custom <code>Torch</code> training loop and tail model customisation. The approach isn't the most straightforward but it is one way we can do it. We'll be utilising <code>Massive</code> dataset by Amazon and fine-tune the transformer encoder <code>BERT</code></p>
<!-- more -->

<p><a href="https://colab.research.google.com/drive/1PAjWB7tkkkvgUsobZ3XCX4SXfidYrm5v?usp=sharing"><img alt="Run in Google Colab" src="https://img.shields.io/badge/Colab-Run_in_Google_Colab-blue?logo=Google&amp;logoColor=FDBA18" /></a></p>
<h2 id="background">Background<a class="headerlink" href="#background" title="Permanent link">&para;</a></h2>
<h3 id="what-is-ner">What is NER?<a class="headerlink" href="#what-is-ner" title="Permanent link">&para;</a></h3>
<ul>
<li>NER is a natural language processing technique which identifies and extracts named entities from unstructured text</li>
<li>Named entities refer to words or combination of words that represent specific objects, places etc, in principle it can be anything we define it to be</li>
<li>NER algorithms use Machine or Deep Learning algorithms to analyse text and recognise pattens that indicate the presence of a named entity</li>
</ul>
<h3 id="applications">Applications<a class="headerlink" href="#applications" title="Permanent link">&para;</a></h3>
<p>Named Entity Recognition has a wide range of applications in the field of Natural Language Processing and Information Retrieval. </p>
<p>Few such examples have been listed below<sup id="fnref:footnote"><a class="footnote-ref" href="#fn:footnote">1</a></sup>:</p>
<p>Classifying content for news providers: <br></p>
<blockquote>
<p>A large amount of online content is generated by the news and publishing houses on a daily basis and managing them correctly can be a challenging task for the human workers. Named Entity Recognition can automatically scan entire articles and help in identifying and retrieving major people, organizations, and places discussed in them. Thus articles are automatically categorized in defined hierarchies and the content is also much easily discovered. </p>
</blockquote>
<p>Automatically Summarizing Resumes: <br></p>
<blockquote>
<p>You might have come across various tools that scan your resume and retrieve important information such as Name, Address, Qualification, etc from them. The majority of such tools use the NER software which helps it to retrieve such information. Also one of the challenging tasks faced by the HR Departments across companies is to evaluate a gigantic pile of resumes to shortlist candidates. A lot of these resumes are excessively populated in detail, of which, most of the information is irrelevant to the evaluator. Using the NER model, the relevant information to the evaluator can be easily retrieved from them thereby simplifying the effort required in shortlisting candidates among a pile of resumes.</p>
</blockquote>
<p>Optimizing Search Engine Algorithms: <br></p>
<blockquote>
<p>When designing a search engine algorithm, It would be an inefficient and computational task to search for an entire query across the millions of articles and websites online, an alternate way is to run a NER model on the articles once and store the entities associated with them permanently. Thus for a quick and efficient search, the key tags in the search query can be compared with the tags associated with the website articles</p>
</blockquote>
<p>Powering  Recommendation systems: <br></p>
<blockquote>
<p>NER can be used in developing algorithms for recommender systems that make suggestions based on our search history or on our present activity. This is achieved by extracting the entities associated with the content in our history or previous activity and comparing them with the label assigned to other unseen content. Thus we frequently see the content of our interest.</p>
</blockquote>
<p>Simplifying Customer Support: <br></p>
<blockquote>
<p>Usually, a company gets tons of customer complaints and feedback on a daily basis, and going through each one of them and recognizing the concerned parties is not an easy task. Using NER we can recognize relevant entities in customer complaints and feedback such as Product specifications, department, or company branch location so that the feedback is classified accordingly and forwarded to the appropriate department responsible for the identified product.</p>
</blockquote>
<h2 id="the-dataset">The Dataset<a class="headerlink" href="#the-dataset" title="Permanent link">&para;</a></h2>
<p>To realise <code>NER</code> with Hugginface, we'll be utilising a muli-language dataset <code>massive</code></p>
<h3 id="massive-11">Massive 1.1<a class="headerlink" href="#massive-11" title="Permanent link">&para;</a></h3>
<p>Let's load our dataset <strong>MASSIVE</strong>; the dataset can be found on <strong><a href="https://huggingface.co/datasets/AmazonScience/massive">huggingface</a></strong></p>
<blockquote>
<p>MASSIVE 1.1 is a parallel dataset of &gt; 1M utterances across <strong>52 languages</strong> with annotations for the Natural Language Understanding tasks of intent prediction and slot annotation. Utterances span 60 intents and include 55 slot types. MASSIVE was created by localizing the SLURP dataset, composed of general Intelligent Voice Assistant single-shot interactions.</p>
</blockquote>
<p>We will be utilising this dataset for <strong>Named Entity Recognition</strong>, let's load our dataset, selecting only a subset of the data <code>ru-RU</code>, which is a subset of column <code>locale</code></p>
<p>There are quite a number of ways we can extract data from this dataset, let's use the fastest way:
- By specifying which <code>locale</code> group we want to load (so we don't load everything)
- Define the subset of rows we want to use by using <code>split</code> (eg. train[10:100])</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a><span class="kn">from</span><span class="w"> </span><span class="nn">datasets</span><span class="w"> </span><span class="kn">import</span> <span class="n">load_dataset</span><span class="p">,</span> <span class="n">Dataset</span>
<a id="__codelineno-0-2" name="__codelineno-0-2" href="#__codelineno-0-2"></a>
<a id="__codelineno-0-3" name="__codelineno-0-3" href="#__codelineno-0-3"></a><span class="n">train_dataset</span> <span class="o">=</span> <span class="n">load_dataset</span><span class="p">(</span><span class="s1">&#39;AmazonScience/massive&#39;</span><span class="p">,</span> <span class="s2">&quot;ru-RU&quot;</span><span class="p">,</span><span class="n">split</span><span class="o">=</span><span class="s2">&quot;train[:100]&quot;</span><span class="p">)</span>
<a id="__codelineno-0-4" name="__codelineno-0-4" href="#__codelineno-0-4"></a><span class="n">test_dataset</span> <span class="o">=</span> <span class="n">load_dataset</span><span class="p">(</span><span class="s1">&#39;AmazonScience/massive&#39;</span><span class="p">,</span> <span class="s2">&quot;ru-RU&quot;</span><span class="p">,</span><span class="n">split</span><span class="o">=</span><span class="s2">&quot;test[:100]&quot;</span><span class="p">)</span>
</code></pre></div>
<h3 id="relevant-columns">Relevant Columns<a class="headerlink" href="#relevant-columns" title="Permanent link">&para;</a></h3>
<p>Some samples from our <strong>documents</strong>, located in column <code>utt</code> and NER <strong>Annotations</strong> are located in <code>annot_utt</code>, which is in the format <code>[tag : tokens]</code></p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-1-1" name="__codelineno-1-1" href="#__codelineno-1-1"></a><span class="n">train_dataset</span><span class="p">[</span><span class="s1">&#39;utt&#39;</span><span class="p">][:</span><span class="mi">10</span><span class="p">]</span> 
</code></pre></div>
<div class="highlight"><pre><span></span><code><a id="__codelineno-2-1" name="__codelineno-2-1" href="#__codelineno-2-1"></a>[&#39;разбуди меня в девять утра в пятницу&#39;,
<a id="__codelineno-2-2" name="__codelineno-2-2" href="#__codelineno-2-2"></a>&#39;поставь будильник на два часа вперед&#39;,
<a id="__codelineno-2-3" name="__codelineno-2-3" href="#__codelineno-2-3"></a>&#39;олли тихо&#39;,
<a id="__codelineno-2-4" name="__codelineno-2-4" href="#__codelineno-2-4"></a>&#39;отстановись&#39;,
<a id="__codelineno-2-5" name="__codelineno-2-5" href="#__codelineno-2-5"></a>&#39;олли остановись на десять секунд&#39;,
<a id="__codelineno-2-6" name="__codelineno-2-6" href="#__codelineno-2-6"></a>&#39;остановись на десять секунд&#39;,
<a id="__codelineno-2-7" name="__codelineno-2-7" href="#__codelineno-2-7"></a>&#39;сделай освещение здесь чуть более тёплым&#39;,
<a id="__codelineno-2-8" name="__codelineno-2-8" href="#__codelineno-2-8"></a>&#39;пожалуйста сделай свет подходящий для чтения&#39;,
<a id="__codelineno-2-9" name="__codelineno-2-9" href="#__codelineno-2-9"></a>&#39;время идти спать&#39;,
<a id="__codelineno-2-10" name="__codelineno-2-10" href="#__codelineno-2-10"></a>&#39;олли время спать&#39;]
</code></pre></div>
<div class="highlight"><pre><span></span><code><a id="__codelineno-3-1" name="__codelineno-3-1" href="#__codelineno-3-1"></a><span class="n">train_dataset</span><span class="p">[</span><span class="s1">&#39;annot_utt&#39;</span><span class="p">][:</span><span class="mi">10</span><span class="p">]</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><a id="__codelineno-4-1" name="__codelineno-4-1" href="#__codelineno-4-1"></a>[&#39;разбуди меня в [time : девять утра] в [date : пятницу]&#39;,
<a id="__codelineno-4-2" name="__codelineno-4-2" href="#__codelineno-4-2"></a>&#39;поставь будильник [time : на два часа вперед]&#39;,
<a id="__codelineno-4-3" name="__codelineno-4-3" href="#__codelineno-4-3"></a>&#39;олли тихо&#39;,
<a id="__codelineno-4-4" name="__codelineno-4-4" href="#__codelineno-4-4"></a>&#39;отстановись&#39;,
<a id="__codelineno-4-5" name="__codelineno-4-5" href="#__codelineno-4-5"></a>&#39;олли остановись на [time : десять секунд]&#39;,
<a id="__codelineno-4-6" name="__codelineno-4-6" href="#__codelineno-4-6"></a>&#39;остановись на [time : десять секунд]&#39;,
<a id="__codelineno-4-7" name="__codelineno-4-7" href="#__codelineno-4-7"></a>&#39;сделай освещение здесь чуть более [color_type : тёплым]&#39;,
<a id="__codelineno-4-8" name="__codelineno-4-8" href="#__codelineno-4-8"></a>&#39;пожалуйста сделай свет [color_type : подходящий для чтения]&#39;,
<a id="__codelineno-4-9" name="__codelineno-4-9" href="#__codelineno-4-9"></a>&#39;время идти спать&#39;,
<a id="__codelineno-4-10" name="__codelineno-4-10" href="#__codelineno-4-10"></a>&#39;олли время спать&#39;]
</code></pre></div>
<h2 id="text-preprocessing">Text Preprocessing<a class="headerlink" href="#text-preprocessing" title="Permanent link">&para;</a></h2>
<h3 id="define-tokeniser-model">Define Tokeniser &amp; Model<a class="headerlink" href="#define-tokeniser-model" title="Permanent link">&para;</a></h3>
<p>For preprocessing we'll need a tokeniser, so let's define the tokeniser &amp; the base model</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-5-1" name="__codelineno-5-1" href="#__codelineno-5-1"></a><span class="kn">from</span><span class="w"> </span><span class="nn">transformers</span><span class="w"> </span><span class="kn">import</span> <span class="n">AutoTokenizer</span><span class="p">,</span> <span class="n">AutoModel</span>
<a id="__codelineno-5-2" name="__codelineno-5-2" href="#__codelineno-5-2"></a>
<a id="__codelineno-5-3" name="__codelineno-5-3" href="#__codelineno-5-3"></a><span class="n">tokenizer</span> <span class="o">=</span> <span class="n">AutoTokenizer</span><span class="o">.</span><span class="n">from_pretrained</span><span class="p">(</span><span class="s2">&quot;ai-forever/ruBert-base&quot;</span><span class="p">)</span>
<a id="__codelineno-5-4" name="__codelineno-5-4" href="#__codelineno-5-4"></a><span class="n">MODEL</span> <span class="o">=</span> <span class="n">AutoModel</span><span class="o">.</span><span class="n">from_pretrained</span><span class="p">(</span><span class="s2">&quot;ai-forever/ruBert-base&quot;</span><span class="p">)</span>
<a id="__codelineno-5-5" name="__codelineno-5-5" href="#__codelineno-5-5"></a><span class="c1"># tokenizer = AutoTokenizer.from_pretrained(&quot;bert-base-multilingual-cased&quot;)    # multilingual                      </span>
<a id="__codelineno-5-6" name="__codelineno-5-6" href="#__codelineno-5-6"></a><span class="c1"># model = AutoModel.from_pretrained(&quot;bert-base-multilingual-cased&quot;)            # multilingual</span>
<a id="__codelineno-5-7" name="__codelineno-5-7" href="#__codelineno-5-7"></a><span class="c1"># tokenizer = AutoTokenizer.from_pretrained(&quot;bert-base-uncased&quot;)               # en only</span>
<a id="__codelineno-5-8" name="__codelineno-5-8" href="#__codelineno-5-8"></a><span class="c1"># model = AutoModel.from_pretrained(&quot;bert-base-uncased&quot;)                       # en only</span>
</code></pre></div>
<h3 id="ner-format">NER format<a class="headerlink" href="#ner-format" title="Permanent link">&para;</a></h3>
<p><strong>NER</strong> tagging formats can vary quite a bit, let's utilise class <code>Parser</code> to preprocess the NER format in our dataset</p>
<p>Class <code>Parser</code> contains the relevant preprocessing steps we will take:
- The class will be called when creating our <code>Dataset</code>, creating <strong>NER tags</strong> for each document
- Its input will be the <strong>document</strong> &amp; <strong>annotated document</strong>
    - The document itself is imported in order to create <strong>O tags</strong>
    - Whilst the <strong>annotated document</strong> is used to extract the <strong>annotated tags</strong>
    - Tag dictionaries are created <code>tag_to_id</code>, <code>id_to_tag</code></p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-6-1" name="__codelineno-6-1" href="#__codelineno-6-1"></a><span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">List</span>
<a id="__codelineno-6-2" name="__codelineno-6-2" href="#__codelineno-6-2"></a><span class="kn">import</span><span class="w"> </span><span class="nn">regex</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">re</span>
<a id="__codelineno-6-3" name="__codelineno-6-3" href="#__codelineno-6-3"></a>
<a id="__codelineno-6-4" name="__codelineno-6-4" href="#__codelineno-6-4"></a><span class="sd">&#39;&#39;&#39;</span>
<a id="__codelineno-6-5" name="__codelineno-6-5" href="#__codelineno-6-5"></a>
<a id="__codelineno-6-6" name="__codelineno-6-6" href="#__codelineno-6-6"></a><span class="sd">PARSER FOR THE DATASET NER TAG FORMAT</span>
<a id="__codelineno-6-7" name="__codelineno-6-7" href="#__codelineno-6-7"></a>
<a id="__codelineno-6-8" name="__codelineno-6-8" href="#__codelineno-6-8"></a><span class="sd">&#39;&#39;&#39;</span>
<a id="__codelineno-6-9" name="__codelineno-6-9" href="#__codelineno-6-9"></a>
<a id="__codelineno-6-10" name="__codelineno-6-10" href="#__codelineno-6-10"></a><span class="k">class</span><span class="w"> </span><span class="nc">Parser</span><span class="p">:</span>
<a id="__codelineno-6-11" name="__codelineno-6-11" href="#__codelineno-6-11"></a>
<a id="__codelineno-6-12" name="__codelineno-6-12" href="#__codelineno-6-12"></a>    <span class="c1"># RE patterns for tag extraction</span>
<a id="__codelineno-6-13" name="__codelineno-6-13" href="#__codelineno-6-13"></a>    <span class="n">LABEL_PATTERN</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;\[(.*?)\]&quot;</span>
<a id="__codelineno-6-14" name="__codelineno-6-14" href="#__codelineno-6-14"></a>    <span class="n">PUNCTUATION_PATTERN</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;([.,\/#!$%\^&amp;\*;:</span><span class="si">{}</span><span class="s2">=\-_`~()&#39;</span><span class="se">\&quot;</span><span class="s2">’¿])&quot;</span>
<a id="__codelineno-6-15" name="__codelineno-6-15" href="#__codelineno-6-15"></a>
<a id="__codelineno-6-16" name="__codelineno-6-16" href="#__codelineno-6-16"></a>    <span class="c1"># initialise, first word/id tag is O (outside)</span>
<a id="__codelineno-6-17" name="__codelineno-6-17" href="#__codelineno-6-17"></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a id="__codelineno-6-18" name="__codelineno-6-18" href="#__codelineno-6-18"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">tag_to_id</span> <span class="o">=</span> <span class="p">{</span>
<a id="__codelineno-6-19" name="__codelineno-6-19" href="#__codelineno-6-19"></a>            <span class="s2">&quot;O&quot;</span><span class="p">:</span> <span class="mi">0</span>
<a id="__codelineno-6-20" name="__codelineno-6-20" href="#__codelineno-6-20"></a>        <span class="p">}</span>
<a id="__codelineno-6-21" name="__codelineno-6-21" href="#__codelineno-6-21"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">id_to_tag</span> <span class="o">=</span> <span class="p">{</span>
<a id="__codelineno-6-22" name="__codelineno-6-22" href="#__codelineno-6-22"></a>            <span class="mi">0</span><span class="p">:</span> <span class="s2">&quot;O&quot;</span>
<a id="__codelineno-6-23" name="__codelineno-6-23" href="#__codelineno-6-23"></a>        <span class="p">}</span>
<a id="__codelineno-6-24" name="__codelineno-6-24" href="#__codelineno-6-24"></a>
<a id="__codelineno-6-25" name="__codelineno-6-25" href="#__codelineno-6-25"></a><span class="w">    </span><span class="sd">&#39;&#39;&#39;</span>
<a id="__codelineno-6-26" name="__codelineno-6-26" href="#__codelineno-6-26"></a>
<a id="__codelineno-6-27" name="__codelineno-6-27" href="#__codelineno-6-27"></a><span class="sd">    CREATE TAGS</span>
<a id="__codelineno-6-28" name="__codelineno-6-28" href="#__codelineno-6-28"></a>
<a id="__codelineno-6-29" name="__codelineno-6-29" href="#__codelineno-6-29"></a><span class="sd">    &#39;&#39;&#39;</span>
<a id="__codelineno-6-30" name="__codelineno-6-30" href="#__codelineno-6-30"></a>    <span class="c1"># input : sentence, tagged sentence</span>
<a id="__codelineno-6-31" name="__codelineno-6-31" href="#__codelineno-6-31"></a>
<a id="__codelineno-6-32" name="__codelineno-6-32" href="#__codelineno-6-32"></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sentence</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">annotated</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
<a id="__codelineno-6-33" name="__codelineno-6-33" href="#__codelineno-6-33"></a>
<a id="__codelineno-6-34" name="__codelineno-6-34" href="#__codelineno-6-34"></a><span class="w">        </span><span class="sd">&#39;&#39;&#39; Create Dictionary of Identified Tags&#39;&#39;&#39;</span>
<a id="__codelineno-6-35" name="__codelineno-6-35" href="#__codelineno-6-35"></a>
<a id="__codelineno-6-36" name="__codelineno-6-36" href="#__codelineno-6-36"></a>        <span class="c1"># 1. set label B or I    </span>
<a id="__codelineno-6-37" name="__codelineno-6-37" href="#__codelineno-6-37"></a>
<a id="__codelineno-6-38" name="__codelineno-6-38" href="#__codelineno-6-38"></a>        <span class="n">matches</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">LABEL_PATTERN</span><span class="p">,</span> <span class="n">annotated</span><span class="p">)</span>
<a id="__codelineno-6-39" name="__codelineno-6-39" href="#__codelineno-6-39"></a>        <span class="n">word_to_tag</span> <span class="o">=</span> <span class="p">{}</span>
<a id="__codelineno-6-40" name="__codelineno-6-40" href="#__codelineno-6-40"></a>        <span class="k">for</span> <span class="n">match</span> <span class="ow">in</span> <span class="n">matches</span><span class="p">:</span>
<a id="__codelineno-6-41" name="__codelineno-6-41" href="#__codelineno-6-41"></a>            <span class="n">tag</span><span class="p">,</span> <span class="n">phrase</span> <span class="o">=</span> <span class="n">match</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot; : &quot;</span><span class="p">)</span>
<a id="__codelineno-6-42" name="__codelineno-6-42" href="#__codelineno-6-42"></a>            <span class="n">words</span> <span class="o">=</span> <span class="n">phrase</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">)</span> 
<a id="__codelineno-6-43" name="__codelineno-6-43" href="#__codelineno-6-43"></a>            <span class="n">word_to_tag</span><span class="p">[</span><span class="n">words</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;B-</span><span class="si">{</span><span class="n">tag</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span>
<a id="__codelineno-6-44" name="__codelineno-6-44" href="#__codelineno-6-44"></a>            <span class="k">for</span> <span class="n">w</span> <span class="ow">in</span> <span class="n">words</span><span class="p">[</span><span class="mi">1</span><span class="p">:]:</span>
<a id="__codelineno-6-45" name="__codelineno-6-45" href="#__codelineno-6-45"></a>                <span class="n">word_to_tag</span><span class="p">[</span><span class="n">w</span><span class="p">]</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;I-</span><span class="si">{</span><span class="n">tag</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span>
<a id="__codelineno-6-46" name="__codelineno-6-46" href="#__codelineno-6-46"></a>
<a id="__codelineno-6-47" name="__codelineno-6-47" href="#__codelineno-6-47"></a><span class="w">        </span><span class="sd">&#39;&#39;&#39; Tokenise Sentence &amp; add tags to not tagged words (O)&#39;&#39;&#39;</span>
<a id="__codelineno-6-48" name="__codelineno-6-48" href="#__codelineno-6-48"></a>
<a id="__codelineno-6-49" name="__codelineno-6-49" href="#__codelineno-6-49"></a>        <span class="c1"># 2. add token tag to main tag dictionary</span>
<a id="__codelineno-6-50" name="__codelineno-6-50" href="#__codelineno-6-50"></a>
<a id="__codelineno-6-51" name="__codelineno-6-51" href="#__codelineno-6-51"></a>        <span class="n">tags</span> <span class="o">=</span> <span class="p">[]</span>
<a id="__codelineno-6-52" name="__codelineno-6-52" href="#__codelineno-6-52"></a>        <span class="n">sentence</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">PUNCTUATION_PATTERN</span><span class="p">,</span> <span class="sa">r</span><span class="s2">&quot; \1 &quot;</span><span class="p">,</span> <span class="n">sentence</span><span class="p">)</span>
<a id="__codelineno-6-53" name="__codelineno-6-53" href="#__codelineno-6-53"></a>        <span class="k">for</span> <span class="n">w</span> <span class="ow">in</span> <span class="n">sentence</span><span class="o">.</span><span class="n">split</span><span class="p">():</span>
<a id="__codelineno-6-54" name="__codelineno-6-54" href="#__codelineno-6-54"></a>            <span class="k">if</span> <span class="n">w</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">word_to_tag</span><span class="p">:</span>
<a id="__codelineno-6-55" name="__codelineno-6-55" href="#__codelineno-6-55"></a>                <span class="n">tags</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;O&quot;</span><span class="p">)</span>
<a id="__codelineno-6-56" name="__codelineno-6-56" href="#__codelineno-6-56"></a>            <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-6-57" name="__codelineno-6-57" href="#__codelineno-6-57"></a>                <span class="n">tags</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">word_to_tag</span><span class="p">[</span><span class="n">w</span><span class="p">])</span>
<a id="__codelineno-6-58" name="__codelineno-6-58" href="#__codelineno-6-58"></a>                <span class="bp">self</span><span class="o">.</span><span class="n">__add_tag</span><span class="p">(</span><span class="n">word_to_tag</span><span class="p">[</span><span class="n">w</span><span class="p">])</span>
<a id="__codelineno-6-59" name="__codelineno-6-59" href="#__codelineno-6-59"></a>
<a id="__codelineno-6-60" name="__codelineno-6-60" href="#__codelineno-6-60"></a>        <span class="k">return</span> <span class="n">tags</span>
<a id="__codelineno-6-61" name="__codelineno-6-61" href="#__codelineno-6-61"></a>
<a id="__codelineno-6-62" name="__codelineno-6-62" href="#__codelineno-6-62"></a><span class="w">    </span><span class="sd">&#39;&#39;&#39;</span>
<a id="__codelineno-6-63" name="__codelineno-6-63" href="#__codelineno-6-63"></a>
<a id="__codelineno-6-64" name="__codelineno-6-64" href="#__codelineno-6-64"></a><span class="sd">    TAG CONVERSION</span>
<a id="__codelineno-6-65" name="__codelineno-6-65" href="#__codelineno-6-65"></a>
<a id="__codelineno-6-66" name="__codelineno-6-66" href="#__codelineno-6-66"></a><span class="sd">    &#39;&#39;&#39;</span>
<a id="__codelineno-6-67" name="__codelineno-6-67" href="#__codelineno-6-67"></a>    <span class="c1"># to word2id (tag_to_id)</span>
<a id="__codelineno-6-68" name="__codelineno-6-68" href="#__codelineno-6-68"></a>    <span class="c1"># to id2word (id_to_tag)</span>
<a id="__codelineno-6-69" name="__codelineno-6-69" href="#__codelineno-6-69"></a>
<a id="__codelineno-6-70" name="__codelineno-6-70" href="#__codelineno-6-70"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">__add_tag</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tag</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
<a id="__codelineno-6-71" name="__codelineno-6-71" href="#__codelineno-6-71"></a>        <span class="k">if</span> <span class="n">tag</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">tag_to_id</span><span class="p">:</span>
<a id="__codelineno-6-72" name="__codelineno-6-72" href="#__codelineno-6-72"></a>            <span class="k">return</span>
<a id="__codelineno-6-73" name="__codelineno-6-73" href="#__codelineno-6-73"></a>        <span class="n">id_</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tag_to_id</span><span class="p">)</span>
<a id="__codelineno-6-74" name="__codelineno-6-74" href="#__codelineno-6-74"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">tag_to_id</span><span class="p">[</span><span class="n">tag</span><span class="p">]</span> <span class="o">=</span> <span class="n">id_</span>
<a id="__codelineno-6-75" name="__codelineno-6-75" href="#__codelineno-6-75"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">id_to_tag</span><span class="p">[</span><span class="n">id_</span><span class="p">]</span> <span class="o">=</span> <span class="n">tag</span>
<a id="__codelineno-6-76" name="__codelineno-6-76" href="#__codelineno-6-76"></a>
<a id="__codelineno-6-77" name="__codelineno-6-77" href="#__codelineno-6-77"></a><span class="w">    </span><span class="sd">&#39;&#39;&#39; Get Tag Number ID &#39;&#39;&#39;</span>
<a id="__codelineno-6-78" name="__codelineno-6-78" href="#__codelineno-6-78"></a>    <span class="c1"># or just number id for token</span>
<a id="__codelineno-6-79" name="__codelineno-6-79" href="#__codelineno-6-79"></a>
<a id="__codelineno-6-80" name="__codelineno-6-80" href="#__codelineno-6-80"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">get_id</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tag</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
<a id="__codelineno-6-81" name="__codelineno-6-81" href="#__codelineno-6-81"></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">tag_to_id</span><span class="p">[</span><span class="n">tag</span><span class="p">]</span>
<a id="__codelineno-6-82" name="__codelineno-6-82" href="#__codelineno-6-82"></a>
<a id="__codelineno-6-83" name="__codelineno-6-83" href="#__codelineno-6-83"></a><span class="w">    </span><span class="sd">&#39;&#39;&#39; Get Tag Token from Number ID&#39;&#39;&#39;</span>
<a id="__codelineno-6-84" name="__codelineno-6-84" href="#__codelineno-6-84"></a>    <span class="c1"># given id get its token</span>
<a id="__codelineno-6-85" name="__codelineno-6-85" href="#__codelineno-6-85"></a>
<a id="__codelineno-6-86" name="__codelineno-6-86" href="#__codelineno-6-86"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">get_label</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">id_</span><span class="p">:</span> <span class="nb">int</span><span class="p">):</span>
<a id="__codelineno-6-87" name="__codelineno-6-87" href="#__codelineno-6-87"></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_tag_label</span><span class="p">(</span><span class="n">id_</span><span class="p">)</span>
<a id="__codelineno-6-88" name="__codelineno-6-88" href="#__codelineno-6-88"></a>
<a id="__codelineno-6-89" name="__codelineno-6-89" href="#__codelineno-6-89"></a><span class="n">parser</span> <span class="o">=</span> <span class="n">Parser</span><span class="p">()</span>
<a id="__codelineno-6-90" name="__codelineno-6-90" href="#__codelineno-6-90"></a><span class="n">parser</span><span class="p">(</span><span class="n">train_dataset</span><span class="p">[</span><span class="s2">&quot;utt&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="n">train_dataset</span><span class="p">[</span><span class="s2">&quot;annot_utt&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><a id="__codelineno-7-1" name="__codelineno-7-1" href="#__codelineno-7-1"></a>[&#39;O&#39;, &#39;O&#39;, &#39;O&#39;, &#39;B-TIME&#39;, &#39;I-TIME&#39;, &#39;O&#39;, &#39;B-DATE&#39;]
</code></pre></div>
<h3 id="create-dataset">Create Dataset<a class="headerlink" href="#create-dataset" title="Permanent link">&para;</a></h3>
<p>The functions <code>NERDataset</code> is our Dataset class, it requires the <code>Parser</code> class instance </p>
<p>Input into the <code>parser</code> orbjects are <code>utt</code> &amp; its annotated version <code>annot_utt</code></p>
<p>The output from <code>parser</code> will be a list of target variable tags <code>BIO</code> tags</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-8-1" name="__codelineno-8-1" href="#__codelineno-8-1"></a>[&#39;O&#39;, &#39;O&#39;, &#39;O&#39;, &#39;B-TIME&#39;, &#39;I-TIME&#39;, &#39;O&#39;, &#39;B-DATE&#39;]
<a id="__codelineno-8-2" name="__codelineno-8-2" href="#__codelineno-8-2"></a>[&#39;O&#39;, &#39;O&#39;, &#39;B-TIME&#39;, &#39;I-TIME&#39;, &#39;I-TIME&#39;, &#39;I-TIME&#39;]
<a id="__codelineno-8-3" name="__codelineno-8-3" href="#__codelineno-8-3"></a>[&#39;O&#39;, &#39;O&#39;]
<a id="__codelineno-8-4" name="__codelineno-8-4" href="#__codelineno-8-4"></a>[&#39;O&#39;]
<a id="__codelineno-8-5" name="__codelineno-8-5" href="#__codelineno-8-5"></a>[&#39;O&#39;, &#39;O&#39;, &#39;O&#39;, &#39;B-TIME&#39;, &#39;I-TIME&#39;]
<a id="__codelineno-8-6" name="__codelineno-8-6" href="#__codelineno-8-6"></a>[&#39;O&#39;, &#39;O&#39;, &#39;B-TIME&#39;, &#39;I-TIME&#39;]
<a id="__codelineno-8-7" name="__codelineno-8-7" href="#__codelineno-8-7"></a>[&#39;O&#39;, &#39;O&#39;, &#39;O&#39;, &#39;O&#39;, &#39;O&#39;, &#39;B-COLOR_TYPE&#39;]
<a id="__codelineno-8-8" name="__codelineno-8-8" href="#__codelineno-8-8"></a>[&#39;O&#39;, &#39;O&#39;, &#39;O&#39;, &#39;B-COLOR_TYPE&#39;, &#39;I-COLOR_TYPE&#39;, &#39;I-COLOR_TYPE&#39;]
<a id="__codelineno-8-9" name="__codelineno-8-9" href="#__codelineno-8-9"></a>[&#39;O&#39;, &#39;O&#39;, &#39;O&#39;]
</code></pre></div>
<p>The <code>NERDataset</code> output each item (document) looks like the following:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-9-1" name="__codelineno-9-1" href="#__codelineno-9-1"></a><span class="n">tmp</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
<a id="__codelineno-9-2" name="__codelineno-9-2" href="#__codelineno-9-2"></a>    <span class="o">**</span><span class="n">tokenizer_output</span><span class="p">,</span>                             <span class="c1"># BERT related token inputs</span>
<a id="__codelineno-9-3" name="__codelineno-9-3" href="#__codelineno-9-3"></a>    <span class="s2">&quot;subword_group&quot;</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">subword_group</span><span class="p">),</span>   <span class="c1"># token/word association (start,number of tokens in word)</span>
<a id="__codelineno-9-4" name="__codelineno-9-4" href="#__codelineno-9-4"></a>    <span class="s2">&quot;target&quot;</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">target</span><span class="p">)</span>                  <span class="c1"># word NER tag</span>
<a id="__codelineno-9-5" name="__codelineno-9-5" href="#__codelineno-9-5"></a><span class="p">}</span>
</code></pre></div>
<p>Now the class itself:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-10-1" name="__codelineno-10-1" href="#__codelineno-10-1"></a><span class="kn">from</span><span class="w"> </span><span class="nn">torch.utils.data</span><span class="w"> </span><span class="kn">import</span> <span class="n">Dataset</span><span class="p">,</span> <span class="n">DataLoader</span>
<a id="__codelineno-10-2" name="__codelineno-10-2" href="#__codelineno-10-2"></a>
<a id="__codelineno-10-3" name="__codelineno-10-3" href="#__codelineno-10-3"></a><span class="k">class</span><span class="w"> </span><span class="nc">NERDataset</span><span class="p">(</span><span class="n">Dataset</span><span class="p">):</span>
<a id="__codelineno-10-4" name="__codelineno-10-4" href="#__codelineno-10-4"></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dataset</span><span class="p">,</span> <span class="n">tokenizer</span><span class="p">):</span>
<a id="__codelineno-10-5" name="__codelineno-10-5" href="#__codelineno-10-5"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">tokenizer</span> <span class="o">=</span> <span class="n">tokenizer</span>
<a id="__codelineno-10-6" name="__codelineno-10-6" href="#__codelineno-10-6"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">processed_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__preprocess</span><span class="p">(</span><span class="n">dataset</span><span class="p">)</span>
<a id="__codelineno-10-7" name="__codelineno-10-7" href="#__codelineno-10-7"></a>
<a id="__codelineno-10-8" name="__codelineno-10-8" href="#__codelineno-10-8"></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__len__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a id="__codelineno-10-9" name="__codelineno-10-9" href="#__codelineno-10-9"></a>        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">processed_data</span><span class="p">)</span>
<a id="__codelineno-10-10" name="__codelineno-10-10" href="#__codelineno-10-10"></a>
<a id="__codelineno-10-11" name="__codelineno-10-11" href="#__codelineno-10-11"></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">idx</span><span class="p">):</span>
<a id="__codelineno-10-12" name="__codelineno-10-12" href="#__codelineno-10-12"></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">processed_data</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>
<a id="__codelineno-10-13" name="__codelineno-10-13" href="#__codelineno-10-13"></a>
<a id="__codelineno-10-14" name="__codelineno-10-14" href="#__codelineno-10-14"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">__preprocess</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dataset</span><span class="p">):</span>
<a id="__codelineno-10-15" name="__codelineno-10-15" href="#__codelineno-10-15"></a>
<a id="__codelineno-10-16" name="__codelineno-10-16" href="#__codelineno-10-16"></a>        <span class="n">tmp</span> <span class="o">=</span> <span class="p">{}</span>
<a id="__codelineno-10-17" name="__codelineno-10-17" href="#__codelineno-10-17"></a>        <span class="k">for</span> <span class="n">idx</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">dataset</span><span class="p">))):</span>
<a id="__codelineno-10-18" name="__codelineno-10-18" href="#__codelineno-10-18"></a>            <span class="n">item</span> <span class="o">=</span> <span class="n">dataset</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>
<a id="__codelineno-10-19" name="__codelineno-10-19" href="#__codelineno-10-19"></a>            <span class="n">tags</span> <span class="o">=</span> <span class="n">parser</span><span class="p">(</span><span class="n">item</span><span class="p">[</span><span class="s2">&quot;utt&quot;</span><span class="p">],</span> <span class="n">item</span><span class="p">[</span><span class="s2">&quot;annot_utt&quot;</span><span class="p">])</span>     <span class="c1"># get list of tags</span>
<a id="__codelineno-10-20" name="__codelineno-10-20" href="#__codelineno-10-20"></a>            <span class="n">tokenizer_output</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tokenizer</span><span class="p">(</span><span class="n">item</span><span class="p">[</span><span class="s2">&quot;utt&quot;</span><span class="p">],</span>    <span class="c1"># tokenise document (incl. &lt;bos&gt;,&lt;eos&gt;)</span>
<a id="__codelineno-10-21" name="__codelineno-10-21" href="#__codelineno-10-21"></a>                                              <span class="n">padding</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> 
<a id="__codelineno-10-22" name="__codelineno-10-22" href="#__codelineno-10-22"></a>                                              <span class="n">truncation</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> 
<a id="__codelineno-10-23" name="__codelineno-10-23" href="#__codelineno-10-23"></a>                                              <span class="n">return_tensors</span><span class="o">=</span><span class="s1">&#39;pt&#39;</span><span class="p">)</span>
<a id="__codelineno-10-24" name="__codelineno-10-24" href="#__codelineno-10-24"></a>
<a id="__codelineno-10-25" name="__codelineno-10-25" href="#__codelineno-10-25"></a>            <span class="c1"># token word identifier (each word can have multiple tokens)</span>
<a id="__codelineno-10-26" name="__codelineno-10-26" href="#__codelineno-10-26"></a>            <span class="n">word_ids</span> <span class="o">=</span> <span class="n">tokenizer_output</span><span class="o">.</span><span class="n">word_ids</span><span class="p">()</span> 
<a id="__codelineno-10-27" name="__codelineno-10-27" href="#__codelineno-10-27"></a>
<a id="__codelineno-10-28" name="__codelineno-10-28" href="#__codelineno-10-28"></a>            <span class="c1"># for each word, how many subtokens are there (starts with 1 - first word)</span>
<a id="__codelineno-10-29" name="__codelineno-10-29" href="#__codelineno-10-29"></a>            <span class="n">subword_group</span> <span class="o">=</span> <span class="p">[</span>
<a id="__codelineno-10-30" name="__codelineno-10-30" href="#__codelineno-10-30"></a>                <span class="p">(</span><span class="n">key</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">group</span><span class="p">)))</span> 
<a id="__codelineno-10-31" name="__codelineno-10-31" href="#__codelineno-10-31"></a>                <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">group</span> <span class="ow">in</span> <span class="n">itertools</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="n">word_ids</span><span class="p">)</span> 
<a id="__codelineno-10-32" name="__codelineno-10-32" href="#__codelineno-10-32"></a>                    <span class="k">if</span> <span class="n">key</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
<a id="__codelineno-10-33" name="__codelineno-10-33" href="#__codelineno-10-33"></a>            <span class="p">]</span> <span class="c1"># index to aggregate tokens</span>
<a id="__codelineno-10-34" name="__codelineno-10-34" href="#__codelineno-10-34"></a>
<a id="__codelineno-10-35" name="__codelineno-10-35" href="#__codelineno-10-35"></a>            <span class="c1"># define bio tags for each word in numerical format using parser</span>
<a id="__codelineno-10-36" name="__codelineno-10-36" href="#__codelineno-10-36"></a>            <span class="n">target</span> <span class="o">=</span> <span class="p">[</span><span class="n">parser</span><span class="o">.</span><span class="n">get_id</span><span class="p">(</span><span class="n">t</span><span class="p">)</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">tags</span><span class="p">]</span> 
<a id="__codelineno-10-37" name="__codelineno-10-37" href="#__codelineno-10-37"></a>
<a id="__codelineno-10-38" name="__codelineno-10-38" href="#__codelineno-10-38"></a>            <span class="c1"># group all relevant data that will be used in forward pass</span>
<a id="__codelineno-10-39" name="__codelineno-10-39" href="#__codelineno-10-39"></a>            <span class="n">tmp</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
<a id="__codelineno-10-40" name="__codelineno-10-40" href="#__codelineno-10-40"></a>                <span class="o">**</span><span class="n">tokenizer_output</span><span class="p">,</span>
<a id="__codelineno-10-41" name="__codelineno-10-41" href="#__codelineno-10-41"></a>                <span class="s2">&quot;subword_group&quot;</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">subword_group</span><span class="p">),</span>
<a id="__codelineno-10-42" name="__codelineno-10-42" href="#__codelineno-10-42"></a>                <span class="s2">&quot;target&quot;</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">target</span><span class="p">)</span>
<a id="__codelineno-10-43" name="__codelineno-10-43" href="#__codelineno-10-43"></a>            <span class="p">}</span>
<a id="__codelineno-10-44" name="__codelineno-10-44" href="#__codelineno-10-44"></a>
<a id="__codelineno-10-45" name="__codelineno-10-45" href="#__codelineno-10-45"></a>            <span class="c1"># check consistency</span>
<a id="__codelineno-10-46" name="__codelineno-10-46" href="#__codelineno-10-46"></a>            <span class="k">try</span><span class="p">:</span>
<a id="__codelineno-10-47" name="__codelineno-10-47" href="#__codelineno-10-47"></a>                <span class="k">assert</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">subword_group</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">target</span><span class="p">))</span>
<a id="__codelineno-10-48" name="__codelineno-10-48" href="#__codelineno-10-48"></a>            <span class="k">except</span><span class="p">:</span>
<a id="__codelineno-10-49" name="__codelineno-10-49" href="#__codelineno-10-49"></a>                <span class="nb">print</span><span class="p">(</span><span class="n">item</span><span class="p">[</span><span class="s2">&quot;annot_utt&quot;</span><span class="p">],</span> <span class="n">subword_group</span><span class="p">,</span> <span class="n">target</span><span class="p">)</span>
<a id="__codelineno-10-50" name="__codelineno-10-50" href="#__codelineno-10-50"></a>
<a id="__codelineno-10-51" name="__codelineno-10-51" href="#__codelineno-10-51"></a>        <span class="k">return</span> <span class="n">tmp</span>
<a id="__codelineno-10-52" name="__codelineno-10-52" href="#__codelineno-10-52"></a>
<a id="__codelineno-10-53" name="__codelineno-10-53" href="#__codelineno-10-53"></a><span class="n">train</span> <span class="o">=</span> <span class="n">NERDataset</span><span class="p">(</span><span class="n">train_dataset</span><span class="p">,</span> <span class="n">tokenizer</span><span class="p">)</span>
<a id="__codelineno-10-54" name="__codelineno-10-54" href="#__codelineno-10-54"></a><span class="n">test</span> <span class="o">=</span> <span class="n">NERDataset</span><span class="p">(</span><span class="n">test_dataset</span><span class="p">,</span> <span class="n">tokenizer</span><span class="p">)</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><a id="__codelineno-11-1" name="__codelineno-11-1" href="#__codelineno-11-1"></a>  0%|          | 0/1000 [00:00&lt;?, ?it/s]Asking to truncate to max_length but no maximum length is provided and the model has no predefined maximum length. Default to no truncation.
<a id="__codelineno-11-2" name="__codelineno-11-2" href="#__codelineno-11-2"></a>100%|██████████| 1000/1000 [00:00&lt;00:00, 1690.12it/s]
<a id="__codelineno-11-3" name="__codelineno-11-3" href="#__codelineno-11-3"></a>100%|██████████| 1000/1000 [00:00&lt;00:00, 1598.76it/s]
</code></pre></div>
<h2 id="bert-multiclass-classifier">BERT Multiclass Classifier<a class="headerlink" href="#bert-multiclass-classifier" title="Permanent link">&para;</a></h2>
<p>We will use a rather custom approach to <code>NER</code>, we have loaded our <code>encoder</code> model, so we'll need to create a tail end for it, so we can use it for <code>NER</code> multiclass classification</p>
<h3 id="model-architecture">Model Architecture<a class="headerlink" href="#model-architecture" title="Permanent link">&para;</a></h3>
<p>Let's create a custom training &amp; evaluation loop for our <strong>NER multiclass classification</strong> problem</p>
<ul>
<li>In total we have 34 classification tags (including O), so we can define the tail output dimension</li>
<li>Training the BERT model using <code>input_ids</code> &amp; <code>attention_mask</code> (tokens) we extract the <strong>hidden state</strong> for all <strong>tokens</strong> in document</li>
<li>Using the created <code>subword_group</code> data, we extract the <strong>token embeddings</strong> that correpospond to each word in the document</li>
<li>For words which have more than one token, we <strong>average token embeddings</strong> to obtain <strong>word embeddings</strong></li>
<li>The <strong>word embeddings</strong> are passed to the linear tail classifier, which returns the <strong>logits for each word</strong> in the sentence</li>
<li>To get the most probable <strong>tag for each word</strong> in the document, we use <code>torch.argmax</code></li>
</ul>
<p>To utilise our custom model with methods such as <code>.from_pretrained</code>, let's add <code>PreTrainedModel</code>, which contains <code>nn.Module</code></p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-12-1" name="__codelineno-12-1" href="#__codelineno-12-1"></a><span class="kn">import</span><span class="w"> </span><span class="nn">torch.nn</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">nn</span>
<a id="__codelineno-12-2" name="__codelineno-12-2" href="#__codelineno-12-2"></a><span class="kn">from</span><span class="w"> </span><span class="nn">transformers</span><span class="w"> </span><span class="kn">import</span> <span class="n">PreTrainedModel</span>
<a id="__codelineno-12-3" name="__codelineno-12-3" href="#__codelineno-12-3"></a><span class="kn">from</span><span class="w"> </span><span class="nn">transformers</span><span class="w"> </span><span class="kn">import</span> <span class="n">PretrainedConfig</span>
<a id="__codelineno-12-4" name="__codelineno-12-4" href="#__codelineno-12-4"></a><span class="kn">from</span><span class="w"> </span><span class="nn">transformers</span><span class="w"> </span><span class="kn">import</span> <span class="n">AutoModel</span><span class="p">,</span> <span class="n">AutoConfig</span>
<a id="__codelineno-12-5" name="__codelineno-12-5" href="#__codelineno-12-5"></a>
<a id="__codelineno-12-6" name="__codelineno-12-6" href="#__codelineno-12-6"></a><span class="k">class</span><span class="w"> </span><span class="nc">MyConfig</span><span class="p">(</span><span class="n">PretrainedConfig</span><span class="p">):</span>
<a id="__codelineno-12-7" name="__codelineno-12-7" href="#__codelineno-12-7"></a>    <span class="n">model_type</span> <span class="o">=</span> <span class="s1">&#39;mymodel&#39;</span>
<a id="__codelineno-12-8" name="__codelineno-12-8" href="#__codelineno-12-8"></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">important_param</span><span class="o">=</span><span class="mi">42</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<a id="__codelineno-12-9" name="__codelineno-12-9" href="#__codelineno-12-9"></a>        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
<a id="__codelineno-12-10" name="__codelineno-12-10" href="#__codelineno-12-10"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">important_param</span> <span class="o">=</span> <span class="n">important_param</span>
<a id="__codelineno-12-11" name="__codelineno-12-11" href="#__codelineno-12-11"></a>
<a id="__codelineno-12-12" name="__codelineno-12-12" href="#__codelineno-12-12"></a><span class="c1"># PreTrainedModel has nn.Module</span>
<a id="__codelineno-12-13" name="__codelineno-12-13" href="#__codelineno-12-13"></a>
<a id="__codelineno-12-14" name="__codelineno-12-14" href="#__codelineno-12-14"></a><span class="k">class</span><span class="w"> </span><span class="nc">NERClassifier</span><span class="p">(</span><span class="n">PreTrainedModel</span><span class="p">):</span>
<a id="__codelineno-12-15" name="__codelineno-12-15" href="#__codelineno-12-15"></a>
<a id="__codelineno-12-16" name="__codelineno-12-16" href="#__codelineno-12-16"></a>    <span class="n">config_class</span> <span class="o">=</span> <span class="n">MyConfig</span>
<a id="__codelineno-12-17" name="__codelineno-12-17" href="#__codelineno-12-17"></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">config</span><span class="p">):</span>
<a id="__codelineno-12-18" name="__codelineno-12-18" href="#__codelineno-12-18"></a>        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">config</span><span class="p">)</span>
<a id="__codelineno-12-19" name="__codelineno-12-19" href="#__codelineno-12-19"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">bert</span> <span class="o">=</span> <span class="n">MODEL</span>
<a id="__codelineno-12-20" name="__codelineno-12-20" href="#__codelineno-12-20"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">seq</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Sequential</span><span class="p">(</span>
<a id="__codelineno-12-21" name="__codelineno-12-21" href="#__codelineno-12-21"></a>            <span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="mi">768</span><span class="p">,</span> <span class="mi">256</span><span class="p">),</span> 
<a id="__codelineno-12-22" name="__codelineno-12-22" href="#__codelineno-12-22"></a>            <span class="n">nn</span><span class="o">.</span><span class="n">ReLU</span><span class="p">(),</span>
<a id="__codelineno-12-23" name="__codelineno-12-23" href="#__codelineno-12-23"></a>            <span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="mi">256</span><span class="p">,</span> <span class="n">CLASSES</span><span class="p">),</span>
<a id="__codelineno-12-24" name="__codelineno-12-24" href="#__codelineno-12-24"></a>        <span class="p">)</span>
<a id="__codelineno-12-25" name="__codelineno-12-25" href="#__codelineno-12-25"></a>
<a id="__codelineno-12-26" name="__codelineno-12-26" href="#__codelineno-12-26"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">inputs</span><span class="p">):</span> <span class="c1"># returns list of targets</span>
<a id="__codelineno-12-27" name="__codelineno-12-27" href="#__codelineno-12-27"></a>
<a id="__codelineno-12-28" name="__codelineno-12-28" href="#__codelineno-12-28"></a>        <span class="c1"># standard inputs for BERT</span>
<a id="__codelineno-12-29" name="__codelineno-12-29" href="#__codelineno-12-29"></a>        <span class="n">bert_output</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">bert</span><span class="p">(</span>
<a id="__codelineno-12-30" name="__codelineno-12-30" href="#__codelineno-12-30"></a>            <span class="n">inputs</span><span class="p">[</span><span class="s2">&quot;input_ids&quot;</span><span class="p">],</span>
<a id="__codelineno-12-31" name="__codelineno-12-31" href="#__codelineno-12-31"></a>            <span class="n">inputs</span><span class="p">[</span><span class="s2">&quot;attention_mask&quot;</span><span class="p">]</span>
<a id="__codelineno-12-32" name="__codelineno-12-32" href="#__codelineno-12-32"></a>        <span class="p">)</span>
<a id="__codelineno-12-33" name="__codelineno-12-33" href="#__codelineno-12-33"></a>
<a id="__codelineno-12-34" name="__codelineno-12-34" href="#__codelineno-12-34"></a>        <span class="c1"># output of transformer encoder will be our hidden state for </span>
<a id="__codelineno-12-35" name="__codelineno-12-35" href="#__codelineno-12-35"></a>        <span class="c1"># each input_ids </span>
<a id="__codelineno-12-36" name="__codelineno-12-36" href="#__codelineno-12-36"></a>        <span class="n">last_hidden_state</span> <span class="o">=</span> <span class="n">bert_output</span><span class="p">[</span><span class="s2">&quot;last_hidden_state&quot;</span><span class="p">]</span>
<a id="__codelineno-12-37" name="__codelineno-12-37" href="#__codelineno-12-37"></a>
<a id="__codelineno-12-38" name="__codelineno-12-38" href="#__codelineno-12-38"></a>        <span class="c1"># tokens correspond tokenizer divisions </span>
<a id="__codelineno-12-39" name="__codelineno-12-39" href="#__codelineno-12-39"></a>        <span class="c1"># each word can be split into multiple tokens</span>
<a id="__codelineno-12-40" name="__codelineno-12-40" href="#__codelineno-12-40"></a>        <span class="c1"># ie. get the mean word embedding </span>
<a id="__codelineno-12-41" name="__codelineno-12-41" href="#__codelineno-12-41"></a>
<a id="__codelineno-12-42" name="__codelineno-12-42" href="#__codelineno-12-42"></a>        <span class="n">target</span> <span class="o">=</span> <span class="p">[]</span>
<a id="__codelineno-12-43" name="__codelineno-12-43" href="#__codelineno-12-43"></a>        <span class="k">for</span> <span class="n">group</span> <span class="ow">in</span> <span class="n">inputs</span><span class="p">[</span><span class="s2">&quot;subword_group&quot;</span><span class="p">]:</span>
<a id="__codelineno-12-44" name="__codelineno-12-44" href="#__codelineno-12-44"></a>            <span class="n">b</span><span class="p">,</span> <span class="n">e</span> <span class="o">=</span> <span class="n">group</span>
<a id="__codelineno-12-45" name="__codelineno-12-45" href="#__codelineno-12-45"></a>            <span class="n">word_embedding</span> <span class="o">=</span> <span class="n">last_hidden_state</span><span class="p">[:,</span> <span class="n">b</span><span class="p">:</span><span class="n">b</span><span class="o">+</span><span class="n">e</span><span class="p">]</span>       <span class="c1"># get the token embeddings</span>
<a id="__codelineno-12-46" name="__codelineno-12-46" href="#__codelineno-12-46"></a>            <span class="n">agg_embedding</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">word_embedding</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>  <span class="c1"># mean word embeddings for tokens</span>
<a id="__codelineno-12-47" name="__codelineno-12-47" href="#__codelineno-12-47"></a>
<a id="__codelineno-12-48" name="__codelineno-12-48" href="#__codelineno-12-48"></a>            <span class="c1"># input mean word embedding (1,768) pass into nn.Sequential linear tail end</span>
<a id="__codelineno-12-49" name="__codelineno-12-49" href="#__codelineno-12-49"></a>            <span class="n">proba</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__forward_one</span><span class="p">(</span><span class="n">agg_embedding</span><span class="p">)</span>    <span class="c1"># logits data </span>
<a id="__codelineno-12-50" name="__codelineno-12-50" href="#__codelineno-12-50"></a>            <span class="n">target</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">proba</span><span class="p">)</span>
<a id="__codelineno-12-51" name="__codelineno-12-51" href="#__codelineno-12-51"></a>
<a id="__codelineno-12-52" name="__codelineno-12-52" href="#__codelineno-12-52"></a>        <span class="n">word_logits</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">stack</span><span class="p">(</span><span class="n">target</span><span class="p">)</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<a id="__codelineno-12-53" name="__codelineno-12-53" href="#__codelineno-12-53"></a>
<a id="__codelineno-12-54" name="__codelineno-12-54" href="#__codelineno-12-54"></a>        <span class="k">return</span> <span class="n">word_logits</span>
<a id="__codelineno-12-55" name="__codelineno-12-55" href="#__codelineno-12-55"></a>
<a id="__codelineno-12-56" name="__codelineno-12-56" href="#__codelineno-12-56"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">__forward_one</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
<a id="__codelineno-12-57" name="__codelineno-12-57" href="#__codelineno-12-57"></a>        <span class="n">logits</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">seq</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
<a id="__codelineno-12-58" name="__codelineno-12-58" href="#__codelineno-12-58"></a>        <span class="k">return</span> <span class="n">logits</span>
</code></pre></div>
<h3 id="model-additions">Model Additions<a class="headerlink" href="#model-additions" title="Permanent link">&para;</a></h3>
<p>Aside from defining the classification model architecture for our base model BERT
- We need to create <strong>dataloaders</strong>, <strong>instantiate</strong> our model (ie tail weights need to be initialised)
- Define the model evaluation criterion (loss function) 
- Define the relevant optimiser to update weights</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-13-1" name="__codelineno-13-1" href="#__codelineno-13-1"></a><span class="kn">import</span><span class="w"> </span><span class="nn">torch.optim</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">optim</span>
<a id="__codelineno-13-2" name="__codelineno-13-2" href="#__codelineno-13-2"></a>
<a id="__codelineno-13-3" name="__codelineno-13-3" href="#__codelineno-13-3"></a><span class="c1"># define data loaders</span>
<a id="__codelineno-13-4" name="__codelineno-13-4" href="#__codelineno-13-4"></a><span class="n">train_loader</span> <span class="o">=</span> <span class="n">DataLoader</span><span class="p">(</span><span class="n">train</span><span class="p">)</span>
<a id="__codelineno-13-5" name="__codelineno-13-5" href="#__codelineno-13-5"></a><span class="n">test_loader</span> <span class="o">=</span> <span class="n">DataLoader</span><span class="p">(</span><span class="n">test</span><span class="p">)</span>
<a id="__codelineno-13-6" name="__codelineno-13-6" href="#__codelineno-13-6"></a><span class="n">CLASSES</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">parser</span><span class="o">.</span><span class="n">tag_to_id</span><span class="p">);</span> <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">CLASSES</span><span class="si">}</span><span class="s1"> labels&#39;</span><span class="p">)</span>
<a id="__codelineno-13-7" name="__codelineno-13-7" href="#__codelineno-13-7"></a><span class="n">config</span> <span class="o">=</span> <span class="n">MyConfig</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span>
<a id="__codelineno-13-8" name="__codelineno-13-8" href="#__codelineno-13-8"></a>
<a id="__codelineno-13-9" name="__codelineno-13-9" href="#__codelineno-13-9"></a><span class="c1"># define classifier model, loss fucntion &amp; optimiser</span>
<a id="__codelineno-13-10" name="__codelineno-13-10" href="#__codelineno-13-10"></a><span class="n">clf</span> <span class="o">=</span> <span class="n">NERClassifier</span><span class="p">(</span><span class="n">config</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>
<a id="__codelineno-13-11" name="__codelineno-13-11" href="#__codelineno-13-11"></a><span class="n">criterion</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">CrossEntropyLoss</span><span class="p">()</span>  <span class="c1"># for multiclass classification </span>
<a id="__codelineno-13-12" name="__codelineno-13-12" href="#__codelineno-13-12"></a><span class="n">optimizer</span> <span class="o">=</span> <span class="n">optim</span><span class="o">.</span><span class="n">Adam</span><span class="p">(</span><span class="n">clf</span><span class="o">.</span><span class="n">parameters</span><span class="p">(),</span> <span class="n">lr</span><span class="o">=</span><span class="mf">1e-5</span><span class="p">)</span>
</code></pre></div>
<p>In total, we have created 63 tags in <code>word_to_tag</code> </p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-14-1" name="__codelineno-14-1" href="#__codelineno-14-1"></a>63 labels
</code></pre></div>
<h3 id="train-model">Train Model<a class="headerlink" href="#train-model" title="Permanent link">&para;</a></h3>
<ul>
<li>Let's train our model for 20 epochs on <code>train_loader</code> &amp; validate the model using <code>test_loader</code> </li>
<li>To check how well the model is performing during training, we will use the <code>accuracy</code> metric</li>
</ul>
<div class="highlight"><pre><span></span><code><a id="__codelineno-15-1" name="__codelineno-15-1" href="#__codelineno-15-1"></a><span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.metrics</span><span class="w"> </span><span class="kn">import</span> <span class="n">accuracy_score</span>
<a id="__codelineno-15-2" name="__codelineno-15-2" href="#__codelineno-15-2"></a>
<a id="__codelineno-15-3" name="__codelineno-15-3" href="#__codelineno-15-3"></a><span class="k">for</span> <span class="n">epoch</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">20</span><span class="p">):</span>
<a id="__codelineno-15-4" name="__codelineno-15-4" href="#__codelineno-15-4"></a>
<a id="__codelineno-15-5" name="__codelineno-15-5" href="#__codelineno-15-5"></a><span class="w">    </span><span class="sd">&#39;&#39;&#39;</span>
<a id="__codelineno-15-6" name="__codelineno-15-6" href="#__codelineno-15-6"></a>
<a id="__codelineno-15-7" name="__codelineno-15-7" href="#__codelineno-15-7"></a><span class="sd">    (1) TRAINING LOOP</span>
<a id="__codelineno-15-8" name="__codelineno-15-8" href="#__codelineno-15-8"></a>
<a id="__codelineno-15-9" name="__codelineno-15-9" href="#__codelineno-15-9"></a><span class="sd">    &#39;&#39;&#39;</span>
<a id="__codelineno-15-10" name="__codelineno-15-10" href="#__codelineno-15-10"></a>
<a id="__codelineno-15-11" name="__codelineno-15-11" href="#__codelineno-15-11"></a>    <span class="n">loss_count</span><span class="p">,</span> <span class="n">loss_sum</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span>
<a id="__codelineno-15-12" name="__codelineno-15-12" href="#__codelineno-15-12"></a>    <span class="n">y_true</span><span class="p">,</span> <span class="n">y_pred</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[]</span>
<a id="__codelineno-15-13" name="__codelineno-15-13" href="#__codelineno-15-13"></a>
<a id="__codelineno-15-14" name="__codelineno-15-14" href="#__codelineno-15-14"></a>    <span class="c1"># switch to training mode, ie backpropagation on</span>
<a id="__codelineno-15-15" name="__codelineno-15-15" href="#__codelineno-15-15"></a>    <span class="n">clf</span><span class="o">.</span><span class="n">train</span><span class="p">()</span>
<a id="__codelineno-15-16" name="__codelineno-15-16" href="#__codelineno-15-16"></a>    <span class="k">for</span> <span class="n">data</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span><span class="n">train_loader</span><span class="p">):</span>
<a id="__codelineno-15-17" name="__codelineno-15-17" href="#__codelineno-15-17"></a>
<a id="__codelineno-15-18" name="__codelineno-15-18" href="#__codelineno-15-18"></a>        <span class="c1"># move data to device</span>
<a id="__codelineno-15-19" name="__codelineno-15-19" href="#__codelineno-15-19"></a>        <span class="n">inputs</span> <span class="o">=</span> <span class="p">{</span>
<a id="__codelineno-15-20" name="__codelineno-15-20" href="#__codelineno-15-20"></a>            <span class="n">key</span><span class="p">:</span> <span class="n">val</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>
<a id="__codelineno-15-21" name="__codelineno-15-21" href="#__codelineno-15-21"></a>            <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">data</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
<a id="__codelineno-15-22" name="__codelineno-15-22" href="#__codelineno-15-22"></a>        <span class="p">}</span>
<a id="__codelineno-15-23" name="__codelineno-15-23" href="#__codelineno-15-23"></a>
<a id="__codelineno-15-24" name="__codelineno-15-24" href="#__codelineno-15-24"></a>        <span class="c1"># logits of belonging to each of the tag class </span>
<a id="__codelineno-15-25" name="__codelineno-15-25" href="#__codelineno-15-25"></a>        <span class="c1"># for all words in document</span>
<a id="__codelineno-15-26" name="__codelineno-15-26" href="#__codelineno-15-26"></a>        <span class="n">outputs</span> <span class="o">=</span> <span class="n">clf</span><span class="p">(</span><span class="n">inputs</span><span class="p">)</span>
<a id="__codelineno-15-27" name="__codelineno-15-27" href="#__codelineno-15-27"></a>
<a id="__codelineno-15-28" name="__codelineno-15-28" href="#__codelineno-15-28"></a>        <span class="c1"># predicted word tag </span>
<a id="__codelineno-15-29" name="__codelineno-15-29" href="#__codelineno-15-29"></a>        <span class="n">word_tag</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">outputs</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span> 
<a id="__codelineno-15-30" name="__codelineno-15-30" href="#__codelineno-15-30"></a>
<a id="__codelineno-15-31" name="__codelineno-15-31" href="#__codelineno-15-31"></a>        <span class="n">y_true</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">inputs</span><span class="p">[</span><span class="s2">&quot;target&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">tolist</span><span class="p">())</span>
<a id="__codelineno-15-32" name="__codelineno-15-32" href="#__codelineno-15-32"></a>        <span class="n">y_pred</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">word_tag</span><span class="p">)</span>        
<a id="__codelineno-15-33" name="__codelineno-15-33" href="#__codelineno-15-33"></a>
<a id="__codelineno-15-34" name="__codelineno-15-34" href="#__codelineno-15-34"></a>        <span class="c1"># calcualate loss</span>
<a id="__codelineno-15-35" name="__codelineno-15-35" href="#__codelineno-15-35"></a>        <span class="n">loss</span> <span class="o">=</span> <span class="n">criterion</span><span class="p">(</span><span class="n">outputs</span><span class="p">,</span> <span class="n">inputs</span><span class="p">[</span><span class="s2">&quot;target&quot;</span><span class="p">])</span>
<a id="__codelineno-15-36" name="__codelineno-15-36" href="#__codelineno-15-36"></a>        <span class="n">loss_count</span> <span class="o">+=</span> <span class="mi">1</span>
<a id="__codelineno-15-37" name="__codelineno-15-37" href="#__codelineno-15-37"></a>        <span class="n">loss_sum</span> <span class="o">+=</span> <span class="n">loss</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>
<a id="__codelineno-15-38" name="__codelineno-15-38" href="#__codelineno-15-38"></a>
<a id="__codelineno-15-39" name="__codelineno-15-39" href="#__codelineno-15-39"></a><span class="c1">#         nn.utils.clip_grad_norm_(</span>
<a id="__codelineno-15-40" name="__codelineno-15-40" href="#__codelineno-15-40"></a><span class="c1">#             parameters=clf.parameters(), max_norm=20</span>
<a id="__codelineno-15-41" name="__codelineno-15-41" href="#__codelineno-15-41"></a><span class="c1">#         )</span>
<a id="__codelineno-15-42" name="__codelineno-15-42" href="#__codelineno-15-42"></a>
<a id="__codelineno-15-43" name="__codelineno-15-43" href="#__codelineno-15-43"></a>        <span class="n">optimizer</span><span class="o">.</span><span class="n">zero_grad</span><span class="p">()</span>
<a id="__codelineno-15-44" name="__codelineno-15-44" href="#__codelineno-15-44"></a>        <span class="n">loss</span><span class="o">.</span><span class="n">backward</span><span class="p">()</span>
<a id="__codelineno-15-45" name="__codelineno-15-45" href="#__codelineno-15-45"></a>        <span class="n">optimizer</span><span class="o">.</span><span class="n">step</span><span class="p">()</span>
<a id="__codelineno-15-46" name="__codelineno-15-46" href="#__codelineno-15-46"></a>
<a id="__codelineno-15-47" name="__codelineno-15-47" href="#__codelineno-15-47"></a>    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Epoch-</span><span class="si">{</span><span class="n">epoch</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="si">}</span><span class="s2">: loss: </span><span class="si">{</span><span class="n">loss_sum</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">loss_count</span><span class="si">}</span><span class="s2">; acc: </span><span class="si">{</span><span class="n">accuracy_score</span><span class="p">(</span><span class="n">y_true</span><span class="p">,</span><span class="w"> </span><span class="n">y_pred</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-15-48" name="__codelineno-15-48" href="#__codelineno-15-48"></a>
<a id="__codelineno-15-49" name="__codelineno-15-49" href="#__codelineno-15-49"></a><span class="w">    </span><span class="sd">&#39;&#39;&#39;</span>
<a id="__codelineno-15-50" name="__codelineno-15-50" href="#__codelineno-15-50"></a>
<a id="__codelineno-15-51" name="__codelineno-15-51" href="#__codelineno-15-51"></a><span class="sd">    (2) VALIDATION LOOP</span>
<a id="__codelineno-15-52" name="__codelineno-15-52" href="#__codelineno-15-52"></a>
<a id="__codelineno-15-53" name="__codelineno-15-53" href="#__codelineno-15-53"></a><span class="sd">    &#39;&#39;&#39;</span>
<a id="__codelineno-15-54" name="__codelineno-15-54" href="#__codelineno-15-54"></a>
<a id="__codelineno-15-55" name="__codelineno-15-55" href="#__codelineno-15-55"></a>    <span class="n">test_loss_sum</span><span class="p">,</span> <span class="n">test_loss_count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span>
<a id="__codelineno-15-56" name="__codelineno-15-56" href="#__codelineno-15-56"></a>    <span class="n">test_true</span><span class="p">,</span> <span class="n">test_pred</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[]</span>
<a id="__codelineno-15-57" name="__codelineno-15-57" href="#__codelineno-15-57"></a>
<a id="__codelineno-15-58" name="__codelineno-15-58" href="#__codelineno-15-58"></a>    <span class="c1"># switch to inference mode</span>
<a id="__codelineno-15-59" name="__codelineno-15-59" href="#__codelineno-15-59"></a>    <span class="k">with</span> <span class="n">torch</span><span class="o">.</span><span class="n">no_grad</span><span class="p">():</span>
<a id="__codelineno-15-60" name="__codelineno-15-60" href="#__codelineno-15-60"></a>        <span class="k">for</span> <span class="n">test_rows</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span><span class="n">test_loader</span><span class="p">):</span>
<a id="__codelineno-15-61" name="__codelineno-15-61" href="#__codelineno-15-61"></a>
<a id="__codelineno-15-62" name="__codelineno-15-62" href="#__codelineno-15-62"></a>            <span class="c1"># move data to device</span>
<a id="__codelineno-15-63" name="__codelineno-15-63" href="#__codelineno-15-63"></a>            <span class="n">test_inputs</span> <span class="o">=</span> <span class="p">{</span>
<a id="__codelineno-15-64" name="__codelineno-15-64" href="#__codelineno-15-64"></a>                <span class="n">key</span><span class="p">:</span> <span class="n">val</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>
<a id="__codelineno-15-65" name="__codelineno-15-65" href="#__codelineno-15-65"></a>                <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">test_rows</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
<a id="__codelineno-15-66" name="__codelineno-15-66" href="#__codelineno-15-66"></a>            <span class="p">}</span>
<a id="__codelineno-15-67" name="__codelineno-15-67" href="#__codelineno-15-67"></a>            <span class="n">test_outputs</span> <span class="o">=</span> <span class="n">clf</span><span class="p">(</span><span class="n">test_inputs</span><span class="p">)</span>
<a id="__codelineno-15-68" name="__codelineno-15-68" href="#__codelineno-15-68"></a>
<a id="__codelineno-15-69" name="__codelineno-15-69" href="#__codelineno-15-69"></a>            <span class="c1"># add metric data</span>
<a id="__codelineno-15-70" name="__codelineno-15-70" href="#__codelineno-15-70"></a>            <span class="n">test_true</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">test_inputs</span><span class="p">[</span><span class="s2">&quot;target&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">tolist</span><span class="p">())</span>
<a id="__codelineno-15-71" name="__codelineno-15-71" href="#__codelineno-15-71"></a>            <span class="n">test_pred</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">test_outputs</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">tolist</span><span class="p">())</span>
<a id="__codelineno-15-72" name="__codelineno-15-72" href="#__codelineno-15-72"></a>
<a id="__codelineno-15-73" name="__codelineno-15-73" href="#__codelineno-15-73"></a>            <span class="n">test_loss</span> <span class="o">=</span> <span class="n">criterion</span><span class="p">(</span><span class="n">test_outputs</span><span class="p">,</span> <span class="n">test_inputs</span><span class="p">[</span><span class="s2">&quot;target&quot;</span><span class="p">])</span>
<a id="__codelineno-15-74" name="__codelineno-15-74" href="#__codelineno-15-74"></a>            <span class="n">test_loss_count</span> <span class="o">+=</span> <span class="mi">1</span>
<a id="__codelineno-15-75" name="__codelineno-15-75" href="#__codelineno-15-75"></a>            <span class="n">test_loss_sum</span> <span class="o">+=</span> <span class="n">test_loss</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>
<a id="__codelineno-15-76" name="__codelineno-15-76" href="#__codelineno-15-76"></a>
<a id="__codelineno-15-77" name="__codelineno-15-77" href="#__codelineno-15-77"></a>
<a id="__codelineno-15-78" name="__codelineno-15-78" href="#__codelineno-15-78"></a>    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Epoch-</span><span class="si">{</span><span class="n">epoch</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="si">}</span><span class="s2">: loss: </span><span class="si">{</span><span class="n">loss_sum</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">loss_count</span><span class="si">}</span><span class="s2">; acc: </span><span class="si">{</span><span class="n">accuracy_score</span><span class="p">(</span><span class="n">y_true</span><span class="p">,</span><span class="w"> </span><span class="n">y_pred</span><span class="p">)</span><span class="si">}</span><span class="s2">,</span><span class="se">\</span>
<a id="__codelineno-15-79" name="__codelineno-15-79" href="#__codelineno-15-79"></a><span class="s2">          val_loss: </span><span class="si">{</span><span class="n">test_loss_sum</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">test_loss_count</span><span class="si">}</span><span class="s2">, val_acc: </span><span class="si">{</span><span class="n">accuracy_score</span><span class="p">(</span><span class="n">test_true</span><span class="p">,</span><span class="w"> </span><span class="n">test_pred</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><a id="__codelineno-16-1" name="__codelineno-16-1" href="#__codelineno-16-1"></a>100%|██████████| 1000/1000 [01:02&lt;00:00, 16.09it/s]
<a id="__codelineno-16-2" name="__codelineno-16-2" href="#__codelineno-16-2"></a>Epoch-1: loss: 1.6441781679093839; acc: 0.7374777271827361
<a id="__codelineno-16-3" name="__codelineno-16-3" href="#__codelineno-16-3"></a>100%|██████████| 1000/1000 [00:11&lt;00:00, 88.19it/s]
<a id="__codelineno-16-4" name="__codelineno-16-4" href="#__codelineno-16-4"></a>Epoch-1: loss: 1.6441781679093839; acc: 0.7374777271827361,          val_loss: 1.2796487891450525, val_acc: 0.7421347230264428
<a id="__codelineno-16-5" name="__codelineno-16-5" href="#__codelineno-16-5"></a>100%|██████████| 1000/1000 [01:00&lt;00:00, 16.50it/s]
<a id="__codelineno-16-6" name="__codelineno-16-6" href="#__codelineno-16-6"></a>Epoch-2: loss: 1.1323998833782971; acc: 0.7539101168085528
<a id="__codelineno-16-7" name="__codelineno-16-7" href="#__codelineno-16-7"></a>100%|██████████| 1000/1000 [00:11&lt;00:00, 87.29it/s]
<a id="__codelineno-16-8" name="__codelineno-16-8" href="#__codelineno-16-8"></a>Epoch-2: loss: 1.1323998833782971; acc: 0.7539101168085528,          val_loss: 1.065644938390702, val_acc: 0.7639451843273499
<a id="__codelineno-16-9" name="__codelineno-16-9" href="#__codelineno-16-9"></a>100%|██████████| 1000/1000 [01:01&lt;00:00, 16.32it/s]
<a id="__codelineno-16-10" name="__codelineno-16-10" href="#__codelineno-16-10"></a>Epoch-3: loss: 0.8694944252893329; acc: 0.7895466244308058
<a id="__codelineno-16-11" name="__codelineno-16-11" href="#__codelineno-16-11"></a>100%|██████████| 1000/1000 [00:11&lt;00:00, 85.78it/s]
<a id="__codelineno-16-12" name="__codelineno-16-12" href="#__codelineno-16-12"></a>Epoch-3: loss: 0.8694944252893329; acc: 0.7895466244308058,          val_loss: 0.9206145468372852, val_acc: 0.7815093611271955
<a id="__codelineno-16-13" name="__codelineno-16-13" href="#__codelineno-16-13"></a>100%|██████████| 1000/1000 [00:58&lt;00:00, 16.95it/s]
<a id="__codelineno-16-14" name="__codelineno-16-14" href="#__codelineno-16-14"></a>Epoch-4: loss: 0.6839374071029015; acc: 0.8204315977034251
<a id="__codelineno-16-15" name="__codelineno-16-15" href="#__codelineno-16-15"></a>100%|██████████| 1000/1000 [00:11&lt;00:00, 84.64it/s]
<a id="__codelineno-16-16" name="__codelineno-16-16" href="#__codelineno-16-16"></a>Epoch-4: loss: 0.6839374071029015; acc: 0.8204315977034251,          val_loss: 0.8384006800730712, val_acc: 0.7915460335842501
<a id="__codelineno-16-17" name="__codelineno-16-17" href="#__codelineno-16-17"></a>100%|██████████| 1000/1000 [00:59&lt;00:00, 16.81it/s]
<a id="__codelineno-16-18" name="__codelineno-16-18" href="#__codelineno-16-18"></a>Epoch-5: loss: 0.5615229318903293; acc: 0.8445852306473965
<a id="__codelineno-16-19" name="__codelineno-16-19" href="#__codelineno-16-19"></a>100%|██████████| 1000/1000 [00:11&lt;00:00, 87.55it/s]
<a id="__codelineno-16-20" name="__codelineno-16-20" href="#__codelineno-16-20"></a>Epoch-5: loss: 0.5615229318903293; acc: 0.8445852306473965,          val_loss: 0.7858886199912521, val_acc: 0.7979154603358425
<a id="__codelineno-16-21" name="__codelineno-16-21" href="#__codelineno-16-21"></a>100%|██████████| 1000/1000 [00:59&lt;00:00, 16.78it/s]
<a id="__codelineno-16-22" name="__codelineno-16-22" href="#__codelineno-16-22"></a>Epoch-6: loss: 0.4753220743876882; acc: 0.8643832904375371
<a id="__codelineno-16-23" name="__codelineno-16-23" href="#__codelineno-16-23"></a>100%|██████████| 1000/1000 [00:11&lt;00:00, 88.00it/s]
<a id="__codelineno-16-24" name="__codelineno-16-24" href="#__codelineno-16-24"></a>Epoch-6: loss: 0.4753220743876882; acc: 0.8643832904375371,          val_loss: 0.8105039822029648, val_acc: 0.7971434086083767
<a id="__codelineno-16-25" name="__codelineno-16-25" href="#__codelineno-16-25"></a>100%|██████████| 1000/1000 [00:59&lt;00:00, 16.81it/s]
<a id="__codelineno-16-26" name="__codelineno-16-26" href="#__codelineno-16-26"></a>Epoch-7: loss: 0.3950597488232888; acc: 0.8774500098990299
<a id="__codelineno-16-27" name="__codelineno-16-27" href="#__codelineno-16-27"></a>100%|██████████| 1000/1000 [00:11&lt;00:00, 84.88it/s]
<a id="__codelineno-16-28" name="__codelineno-16-28" href="#__codelineno-16-28"></a>Epoch-7: loss: 0.3950597488232888; acc: 0.8774500098990299,          val_loss: 0.7834225822311127, val_acc: 0.8062150164060992
<a id="__codelineno-16-29" name="__codelineno-16-29" href="#__codelineno-16-29"></a>100%|██████████| 1000/1000 [00:59&lt;00:00, 16.88it/s]
<a id="__codelineno-16-30" name="__codelineno-16-30" href="#__codelineno-16-30"></a>Epoch-8: loss: 0.33086000567564045; acc: 0.8948723025143536
<a id="__codelineno-16-31" name="__codelineno-16-31" href="#__codelineno-16-31"></a>100%|██████████| 1000/1000 [00:11&lt;00:00, 84.73it/s]
<a id="__codelineno-16-32" name="__codelineno-16-32" href="#__codelineno-16-32"></a>Epoch-8: loss: 0.33086000567564045; acc: 0.8948723025143536,          val_loss: 0.767055139105185, val_acc: 0.8096892491796951
<a id="__codelineno-16-33" name="__codelineno-16-33" href="#__codelineno-16-33"></a>100%|██████████| 1000/1000 [01:00&lt;00:00, 16.50it/s]
<a id="__codelineno-16-34" name="__codelineno-16-34" href="#__codelineno-16-34"></a>Epoch-9: loss: 0.28477367215882987; acc: 0.9103147891506632
<a id="__codelineno-16-35" name="__codelineno-16-35" href="#__codelineno-16-35"></a>100%|██████████| 1000/1000 [00:11&lt;00:00, 85.45it/s]
<a id="__codelineno-16-36" name="__codelineno-16-36" href="#__codelineno-16-36"></a>Epoch-9: loss: 0.28477367215882987; acc: 0.9103147891506632,          val_loss: 0.7778430652543611, val_acc: 0.8029337965643698
<a id="__codelineno-16-37" name="__codelineno-16-37" href="#__codelineno-16-37"></a>100%|██████████| 1000/1000 [00:59&lt;00:00, 16.81it/s]
<a id="__codelineno-16-38" name="__codelineno-16-38" href="#__codelineno-16-38"></a>Epoch-10: loss: 0.23926631732314127; acc: 0.9227875668184518
<a id="__codelineno-16-39" name="__codelineno-16-39" href="#__codelineno-16-39"></a>100%|██████████| 1000/1000 [00:11&lt;00:00, 88.43it/s]
<a id="__codelineno-16-40" name="__codelineno-16-40" href="#__codelineno-16-40"></a>Epoch-10: loss: 0.23926631732314127; acc: 0.9227875668184518,          val_loss: 0.7841836358316068, val_acc: 0.8120054043620922
<a id="__codelineno-16-41" name="__codelineno-16-41" href="#__codelineno-16-41"></a>100%|██████████| 1000/1000 [00:59&lt;00:00, 16.82it/s]
<a id="__codelineno-16-42" name="__codelineno-16-42" href="#__codelineno-16-42"></a>Epoch-11: loss: 0.20171416073056753; acc: 0.9362502474757474
<a id="__codelineno-16-43" name="__codelineno-16-43" href="#__codelineno-16-43"></a>100%|██████████| 1000/1000 [00:11&lt;00:00, 84.28it/s]
<a id="__codelineno-16-44" name="__codelineno-16-44" href="#__codelineno-16-44"></a>Epoch-11: loss: 0.20171416073056753; acc: 0.9362502474757474,          val_loss: 0.849082443419844, val_acc: 0.8104613009071607
<a id="__codelineno-16-45" name="__codelineno-16-45" href="#__codelineno-16-45"></a>100%|██████████| 1000/1000 [00:59&lt;00:00, 16.83it/s]
<a id="__codelineno-16-46" name="__codelineno-16-46" href="#__codelineno-16-46"></a>Epoch-12: loss: 0.17783702248180636; acc: 0.9459512967729162
<a id="__codelineno-16-47" name="__codelineno-16-47" href="#__codelineno-16-47"></a>100%|██████████| 1000/1000 [00:11&lt;00:00, 87.20it/s]
<a id="__codelineno-16-48" name="__codelineno-16-48" href="#__codelineno-16-48"></a>Epoch-12: loss: 0.17783702248180636; acc: 0.9459512967729162,          val_loss: 0.7976406391558412, val_acc: 0.8046709129511678
<a id="__codelineno-16-49" name="__codelineno-16-49" href="#__codelineno-16-49"></a>100%|██████████| 1000/1000 [00:59&lt;00:00, 16.88it/s]
<a id="__codelineno-16-50" name="__codelineno-16-50" href="#__codelineno-16-50"></a>Epoch-13: loss: 0.14918355378504203; acc: 0.9503068699267472
<a id="__codelineno-16-51" name="__codelineno-16-51" href="#__codelineno-16-51"></a>100%|██████████| 1000/1000 [00:11&lt;00:00, 87.37it/s]
<a id="__codelineno-16-52" name="__codelineno-16-52" href="#__codelineno-16-52"></a>Epoch-13: loss: 0.14918355378504203; acc: 0.9503068699267472,          val_loss: 0.8160117758086053, val_acc: 0.8118123914302259
<a id="__codelineno-16-53" name="__codelineno-16-53" href="#__codelineno-16-53"></a>100%|██████████| 1000/1000 [01:00&lt;00:00, 16.60it/s]
<a id="__codelineno-16-54" name="__codelineno-16-54" href="#__codelineno-16-54"></a>Epoch-14: loss: 0.1313198971484453; acc: 0.962383686398733
<a id="__codelineno-16-55" name="__codelineno-16-55" href="#__codelineno-16-55"></a>100%|██████████| 1000/1000 [00:11&lt;00:00, 88.59it/s]
<a id="__codelineno-16-56" name="__codelineno-16-56" href="#__codelineno-16-56"></a>Epoch-14: loss: 0.1313198971484453; acc: 0.962383686398733,          val_loss: 0.8072414025840553, val_acc: 0.815479637135688
<a id="__codelineno-16-57" name="__codelineno-16-57" href="#__codelineno-16-57"></a>100%|██████████| 1000/1000 [00:59&lt;00:00, 16.84it/s]
<a id="__codelineno-16-58" name="__codelineno-16-58" href="#__codelineno-16-58"></a>Epoch-15: loss: 0.11704726772185677; acc: 0.9633735893882399
<a id="__codelineno-16-59" name="__codelineno-16-59" href="#__codelineno-16-59"></a>100%|██████████| 1000/1000 [00:11&lt;00:00, 85.19it/s]
<a id="__codelineno-16-60" name="__codelineno-16-60" href="#__codelineno-16-60"></a>Epoch-15: loss: 0.11704726772185677; acc: 0.9633735893882399,          val_loss: 0.8006598546078457, val_acc: 0.8152866242038217
<a id="__codelineno-16-61" name="__codelineno-16-61" href="#__codelineno-16-61"></a>100%|██████████| 1000/1000 [00:59&lt;00:00, 16.79it/s]
<a id="__codelineno-16-62" name="__codelineno-16-62" href="#__codelineno-16-62"></a>Epoch-16: loss: 0.09824711217604636; acc: 0.9742625222728173
<a id="__codelineno-16-63" name="__codelineno-16-63" href="#__codelineno-16-63"></a>100%|██████████| 1000/1000 [00:11&lt;00:00, 88.90it/s]
<a id="__codelineno-16-64" name="__codelineno-16-64" href="#__codelineno-16-64"></a>Epoch-16: loss: 0.09824711217604636; acc: 0.9742625222728173,          val_loss: 0.8438674144655451, val_acc: 0.8177957923180853
<a id="__codelineno-16-65" name="__codelineno-16-65" href="#__codelineno-16-65"></a>100%|██████████| 1000/1000 [00:59&lt;00:00, 16.79it/s]
<a id="__codelineno-16-66" name="__codelineno-16-66" href="#__codelineno-16-66"></a>Epoch-17: loss: 0.0852395541092883; acc: 0.9750544446644229
<a id="__codelineno-16-67" name="__codelineno-16-67" href="#__codelineno-16-67"></a>100%|██████████| 1000/1000 [00:11&lt;00:00, 88.00it/s]
<a id="__codelineno-16-68" name="__codelineno-16-68" href="#__codelineno-16-68"></a>Epoch-17: loss: 0.0852395541092883; acc: 0.9750544446644229,          val_loss: 0.8193156978896586, val_acc: 0.8143215595444895
<a id="__codelineno-16-69" name="__codelineno-16-69" href="#__codelineno-16-69"></a>100%|██████████| 1000/1000 [00:59&lt;00:00, 16.83it/s]
<a id="__codelineno-16-70" name="__codelineno-16-70" href="#__codelineno-16-70"></a>Epoch-18: loss: 0.07844399727860218; acc: 0.9784201148287468
<a id="__codelineno-16-71" name="__codelineno-16-71" href="#__codelineno-16-71"></a>100%|██████████| 1000/1000 [00:11&lt;00:00, 88.51it/s]
<a id="__codelineno-16-72" name="__codelineno-16-72" href="#__codelineno-16-72"></a>Epoch-18: loss: 0.07844399727860218; acc: 0.9784201148287468,          val_loss: 0.8360713951853868, val_acc: 0.8251302837290099
<a id="__codelineno-16-73" name="__codelineno-16-73" href="#__codelineno-16-73"></a>100%|██████████| 1000/1000 [00:59&lt;00:00, 16.86it/s]
<a id="__codelineno-16-74" name="__codelineno-16-74" href="#__codelineno-16-74"></a>Epoch-19: loss: 0.07729116444718602; acc: 0.9788160760245496
<a id="__codelineno-16-75" name="__codelineno-16-75" href="#__codelineno-16-75"></a>100%|██████████| 1000/1000 [00:11&lt;00:00, 85.81it/s]
<a id="__codelineno-16-76" name="__codelineno-16-76" href="#__codelineno-16-76"></a>Epoch-19: loss: 0.07729116444718602; acc: 0.9788160760245496,          val_loss: 0.8346432074703807, val_acc: 0.8210770121598147
<a id="__codelineno-16-77" name="__codelineno-16-77" href="#__codelineno-16-77"></a>100%|██████████| 1000/1000 [00:59&lt;00:00, 16.82it/s]
<a id="__codelineno-16-78" name="__codelineno-16-78" href="#__codelineno-16-78"></a>Epoch-20: loss: 0.06690881398832789; acc: 0.9798059790140566
<a id="__codelineno-16-79" name="__codelineno-16-79" href="#__codelineno-16-79"></a>100%|██████████| 1000/1000 [00:11&lt;00:00, 88.31it/s]
<a id="__codelineno-16-80" name="__codelineno-16-80" href="#__codelineno-16-80"></a>Epoch-20: loss: 0.06690881398832789; acc: 0.9798059790140566,          val_loss: 0.8577917314651385, val_acc: 0.8183748311136846
<a id="__codelineno-16-81" name="__codelineno-16-81" href="#__codelineno-16-81"></a>100%|██████████| 1000/1000 [00:59&lt;00:00, 16.80it/s]
<a id="__codelineno-16-82" name="__codelineno-16-82" href="#__codelineno-16-82"></a>Epoch-21: loss: 0.05367027178355602; acc: 0.985349435755296
<a id="__codelineno-16-83" name="__codelineno-16-83" href="#__codelineno-16-83"></a>100%|██████████| 1000/1000 [00:11&lt;00:00, 88.59it/s]
<a id="__codelineno-16-84" name="__codelineno-16-84" href="#__codelineno-16-84"></a>Epoch-21: loss: 0.05367027178355602; acc: 0.985349435755296,          val_loss: 0.8853590850097044, val_acc: 0.8235861802740784
<a id="__codelineno-16-85" name="__codelineno-16-85" href="#__codelineno-16-85"></a>100%|██████████| 1000/1000 [00:59&lt;00:00, 16.79it/s]
<a id="__codelineno-16-86" name="__codelineno-16-86" href="#__codelineno-16-86"></a>Epoch-22: loss: 0.04562243979116829; acc: 0.9879231835280142
<a id="__codelineno-16-87" name="__codelineno-16-87" href="#__codelineno-16-87"></a>100%|██████████| 1000/1000 [00:11&lt;00:00, 88.02it/s]
<a id="__codelineno-16-88" name="__codelineno-16-88" href="#__codelineno-16-88"></a>Epoch-22: loss: 0.04562243979116829; acc: 0.9879231835280142,          val_loss: 0.8947100080056626, val_acc: 0.8251302837290099
<a id="__codelineno-16-89" name="__codelineno-16-89" href="#__codelineno-16-89"></a>100%|██████████| 1000/1000 [00:59&lt;00:00, 16.80it/s]
<a id="__codelineno-16-90" name="__codelineno-16-90" href="#__codelineno-16-90"></a>Epoch-23: loss: 0.04487149683444659; acc: 0.9875272223322115
<a id="__codelineno-16-91" name="__codelineno-16-91" href="#__codelineno-16-91"></a>100%|██████████| 1000/1000 [00:11&lt;00:00, 83.96it/s]
<a id="__codelineno-16-92" name="__codelineno-16-92" href="#__codelineno-16-92"></a>Epoch-23: loss: 0.04487149683444659; acc: 0.9875272223322115,          val_loss: 0.9012678128228526, val_acc: 0.8257093225246092
<a id="__codelineno-16-93" name="__codelineno-16-93" href="#__codelineno-16-93"></a>100%|██████████| 1000/1000 [00:59&lt;00:00, 16.83it/s]
<a id="__codelineno-16-94" name="__codelineno-16-94" href="#__codelineno-16-94"></a>Epoch-24: loss: 0.043597472023681805; acc: 0.9869332805385073
<a id="__codelineno-16-95" name="__codelineno-16-95" href="#__codelineno-16-95"></a>100%|██████████| 1000/1000 [00:11&lt;00:00, 88.64it/s]
<a id="__codelineno-16-96" name="__codelineno-16-96" href="#__codelineno-16-96"></a>Epoch-24: loss: 0.043597472023681805; acc: 0.9869332805385073,          val_loss: 0.9172096501152982, val_acc: 0.8272534259795407
<a id="__codelineno-16-97" name="__codelineno-16-97" href="#__codelineno-16-97"></a>100%|██████████| 1000/1000 [00:59&lt;00:00, 16.78it/s]
<a id="__codelineno-16-98" name="__codelineno-16-98" href="#__codelineno-16-98"></a>Epoch-25: loss: 0.039683220311884725; acc: 0.9879231835280142
<a id="__codelineno-16-99" name="__codelineno-16-99" href="#__codelineno-16-99"></a>100%|██████████| 1000/1000 [00:11&lt;00:00, 89.10it/s]
<a id="__codelineno-16-100" name="__codelineno-16-100" href="#__codelineno-16-100"></a>Epoch-25: loss: 0.039683220311884725; acc: 0.9879231835280142,          val_loss: 0.9694385796532524, val_acc: 0.8204979733642154
<a id="__codelineno-16-101" name="__codelineno-16-101" href="#__codelineno-16-101"></a>100%|██████████| 1000/1000 [00:59&lt;00:00, 16.79it/s]
<a id="__codelineno-16-102" name="__codelineno-16-102" href="#__codelineno-16-102"></a>Epoch-26: loss: 0.03646317584309327; acc: 0.9899029895070283
<a id="__codelineno-16-103" name="__codelineno-16-103" href="#__codelineno-16-103"></a>100%|██████████| 1000/1000 [00:11&lt;00:00, 88.90it/s]
<a id="__codelineno-16-104" name="__codelineno-16-104" href="#__codelineno-16-104"></a>Epoch-26: loss: 0.03646317584309327; acc: 0.9899029895070283,          val_loss: 0.9861661683519687, val_acc: 0.8266743871839414
<a id="__codelineno-16-105" name="__codelineno-16-105" href="#__codelineno-16-105"></a>100%|██████████| 1000/1000 [00:59&lt;00:00, 16.75it/s]
<a id="__codelineno-16-106" name="__codelineno-16-106" href="#__codelineno-16-106"></a>Epoch-27: loss: 0.03880691091310382; acc: 0.9893090477133241
<a id="__codelineno-16-107" name="__codelineno-16-107" href="#__codelineno-16-107"></a>100%|██████████| 1000/1000 [00:11&lt;00:00, 84.44it/s]
<a id="__codelineno-16-108" name="__codelineno-16-108" href="#__codelineno-16-108"></a>Epoch-27: loss: 0.03880691091310382; acc: 0.9893090477133241,          val_loss: 0.9058586812789617, val_acc: 0.8210770121598147
<a id="__codelineno-16-109" name="__codelineno-16-109" href="#__codelineno-16-109"></a>100%|██████████| 1000/1000 [00:59&lt;00:00, 16.83it/s]
<a id="__codelineno-16-110" name="__codelineno-16-110" href="#__codelineno-16-110"></a>Epoch-28: loss: 0.037079696985995725; acc: 0.9887151059196199
<a id="__codelineno-16-111" name="__codelineno-16-111" href="#__codelineno-16-111"></a>100%|██████████| 1000/1000 [00:11&lt;00:00, 87.97it/s]
<a id="__codelineno-16-112" name="__codelineno-16-112" href="#__codelineno-16-112"></a>Epoch-28: loss: 0.037079696985995725; acc: 0.9887151059196199,          val_loss: 0.925899648670832, val_acc: 0.8272534259795407
<a id="__codelineno-16-113" name="__codelineno-16-113" href="#__codelineno-16-113"></a>100%|██████████| 1000/1000 [00:59&lt;00:00, 16.94it/s]
<a id="__codelineno-16-114" name="__codelineno-16-114" href="#__codelineno-16-114"></a>Epoch-29: loss: 0.023646224649064154; acc: 0.9932686596713522
<a id="__codelineno-16-115" name="__codelineno-16-115" href="#__codelineno-16-115"></a>100%|██████████| 1000/1000 [00:11&lt;00:00, 88.34it/s]
<a id="__codelineno-16-116" name="__codelineno-16-116" href="#__codelineno-16-116"></a>Epoch-29: loss: 0.023646224649064154; acc: 0.9932686596713522,          val_loss: 0.9826786444298395, val_acc: 0.8230071414784791
<a id="__codelineno-16-117" name="__codelineno-16-117" href="#__codelineno-16-117"></a>100%|██████████| 1000/1000 [00:59&lt;00:00, 16.94it/s]
<a id="__codelineno-16-118" name="__codelineno-16-118" href="#__codelineno-16-118"></a>Epoch-30: loss: 0.030056740869996247; acc: 0.9914868342902395
<a id="__codelineno-16-119" name="__codelineno-16-119" href="#__codelineno-16-119"></a>100%|██████████| 1000/1000 [00:11&lt;00:00, 88.16it/s]
<a id="__codelineno-16-120" name="__codelineno-16-120" href="#__codelineno-16-120"></a>Epoch-30: loss: 0.030056740869996247; acc: 0.9914868342902395,          val_loss: 1.0284815851225262, val_acc: 0.8245512449334106
</code></pre></div>
<h3 id="save-model">Save Model<a class="headerlink" href="#save-model" title="Permanent link">&para;</a></h3>
<p>We can save the model for future use</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-17-1" name="__codelineno-17-1" href="#__codelineno-17-1"></a><span class="n">clf</span><span class="o">.</span><span class="n">save_pretrained</span><span class="p">(</span><span class="s1">&#39;./my_model_dir&#39;</span><span class="p">)</span>
<a id="__codelineno-17-2" name="__codelineno-17-2" href="#__codelineno-17-2"></a><span class="n">tokenizer</span><span class="o">.</span><span class="n">save_pretrained</span><span class="p">(</span><span class="s1">&#39;./my_model_dir&#39;</span><span class="p">)</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><a id="__codelineno-18-1" name="__codelineno-18-1" href="#__codelineno-18-1"></a>(&#39;./my_model_dir/tokenizer_config.json&#39;,
<a id="__codelineno-18-2" name="__codelineno-18-2" href="#__codelineno-18-2"></a> &#39;./my_model_dir/special_tokens_map.json&#39;,
<a id="__codelineno-18-3" name="__codelineno-18-3" href="#__codelineno-18-3"></a> &#39;./my_model_dir/vocab.txt&#39;,
<a id="__codelineno-18-4" name="__codelineno-18-4" href="#__codelineno-18-4"></a> &#39;./my_model_dir/added_tokens.json&#39;,
<a id="__codelineno-18-5" name="__codelineno-18-5" href="#__codelineno-18-5"></a> &#39;./my_model_dir/tokenizer.json&#39;)
</code></pre></div>
<h2 id="using-our-ner-tagger">Using our NER tagger<a class="headerlink" href="#using-our-ner-tagger" title="Permanent link">&para;</a></h2>
<p>We can use our <code>NER</code> tagger by loading a stack of documents and creating a <code>dataset</code>, as we did for the <code>train</code> &amp; <code>test</code> subsets or we can use it for a single sentence, I'll be using a simple inference function.</p>
<h3 id="loading-model">Loading Model<a class="headerlink" href="#loading-model" title="Permanent link">&para;</a></h3>
<p>If we want to load the fine-tuned <code>model</code>, we can use <code>.from_pretrained</code> and specify the folder where ther model is located, 
the <code>tokenizer</code> can be loaded in a similar way</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-19-1" name="__codelineno-19-1" href="#__codelineno-19-1"></a><span class="n">new_model</span> <span class="o">=</span> <span class="n">NERClassifier</span><span class="o">.</span><span class="n">from_pretrained</span><span class="p">(</span><span class="s1">&#39;./my_model_dir&#39;</span><span class="p">)</span>
<a id="__codelineno-19-2" name="__codelineno-19-2" href="#__codelineno-19-2"></a><span class="n">new_model</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><a id="__codelineno-20-1" name="__codelineno-20-1" href="#__codelineno-20-1"></a>NERClassifier(
<a id="__codelineno-20-2" name="__codelineno-20-2" href="#__codelineno-20-2"></a>  (bert): BertModel(
<a id="__codelineno-20-3" name="__codelineno-20-3" href="#__codelineno-20-3"></a>    (embeddings): BertEmbeddings(
<a id="__codelineno-20-4" name="__codelineno-20-4" href="#__codelineno-20-4"></a>      (word_embeddings): Embedding(120138, 768, padding_idx=0)
<a id="__codelineno-20-5" name="__codelineno-20-5" href="#__codelineno-20-5"></a>      (position_embeddings): Embedding(512, 768)
<a id="__codelineno-20-6" name="__codelineno-20-6" href="#__codelineno-20-6"></a>      (token_type_embeddings): Embedding(2, 768)
<a id="__codelineno-20-7" name="__codelineno-20-7" href="#__codelineno-20-7"></a>      (LayerNorm): LayerNorm((768,), eps=1e-12, elementwise_affine=True)
<a id="__codelineno-20-8" name="__codelineno-20-8" href="#__codelineno-20-8"></a>      (dropout): Dropout(p=0.1, inplace=False)
<a id="__codelineno-20-9" name="__codelineno-20-9" href="#__codelineno-20-9"></a>    )
<a id="__codelineno-20-10" name="__codelineno-20-10" href="#__codelineno-20-10"></a>    (encoder): BertEncoder(
<a id="__codelineno-20-11" name="__codelineno-20-11" href="#__codelineno-20-11"></a>      (layer): ModuleList(
<a id="__codelineno-20-12" name="__codelineno-20-12" href="#__codelineno-20-12"></a>        (0-11): 12 x BertLayer(
<a id="__codelineno-20-13" name="__codelineno-20-13" href="#__codelineno-20-13"></a>          (attention): BertAttention(
<a id="__codelineno-20-14" name="__codelineno-20-14" href="#__codelineno-20-14"></a>            (self): BertSelfAttention(
<a id="__codelineno-20-15" name="__codelineno-20-15" href="#__codelineno-20-15"></a>              (query): Linear(in_features=768, out_features=768, bias=True)
<a id="__codelineno-20-16" name="__codelineno-20-16" href="#__codelineno-20-16"></a>              (key): Linear(in_features=768, out_features=768, bias=True)
<a id="__codelineno-20-17" name="__codelineno-20-17" href="#__codelineno-20-17"></a>              (value): Linear(in_features=768, out_features=768, bias=True)
<a id="__codelineno-20-18" name="__codelineno-20-18" href="#__codelineno-20-18"></a>              (dropout): Dropout(p=0.1, inplace=False)
<a id="__codelineno-20-19" name="__codelineno-20-19" href="#__codelineno-20-19"></a>            )
<a id="__codelineno-20-20" name="__codelineno-20-20" href="#__codelineno-20-20"></a>            (output): BertSelfOutput(
<a id="__codelineno-20-21" name="__codelineno-20-21" href="#__codelineno-20-21"></a>              (dense): Linear(in_features=768, out_features=768, bias=True)
<a id="__codelineno-20-22" name="__codelineno-20-22" href="#__codelineno-20-22"></a>              (LayerNorm): LayerNorm((768,), eps=1e-12, elementwise_affine=True)
<a id="__codelineno-20-23" name="__codelineno-20-23" href="#__codelineno-20-23"></a>              (dropout): Dropout(p=0.1, inplace=False)
<a id="__codelineno-20-24" name="__codelineno-20-24" href="#__codelineno-20-24"></a>            )
<a id="__codelineno-20-25" name="__codelineno-20-25" href="#__codelineno-20-25"></a>          )
<a id="__codelineno-20-26" name="__codelineno-20-26" href="#__codelineno-20-26"></a>          (intermediate): BertIntermediate(
<a id="__codelineno-20-27" name="__codelineno-20-27" href="#__codelineno-20-27"></a>            (dense): Linear(in_features=768, out_features=3072, bias=True)
<a id="__codelineno-20-28" name="__codelineno-20-28" href="#__codelineno-20-28"></a>            (intermediate_act_fn): GELUActivation()
<a id="__codelineno-20-29" name="__codelineno-20-29" href="#__codelineno-20-29"></a>          )
<a id="__codelineno-20-30" name="__codelineno-20-30" href="#__codelineno-20-30"></a>          (output): BertOutput(
<a id="__codelineno-20-31" name="__codelineno-20-31" href="#__codelineno-20-31"></a>            (dense): Linear(in_features=3072, out_features=768, bias=True)
<a id="__codelineno-20-32" name="__codelineno-20-32" href="#__codelineno-20-32"></a>            (LayerNorm): LayerNorm((768,), eps=1e-12, elementwise_affine=True)
<a id="__codelineno-20-33" name="__codelineno-20-33" href="#__codelineno-20-33"></a>            (dropout): Dropout(p=0.1, inplace=False)
<a id="__codelineno-20-34" name="__codelineno-20-34" href="#__codelineno-20-34"></a>          )
<a id="__codelineno-20-35" name="__codelineno-20-35" href="#__codelineno-20-35"></a>        )
<a id="__codelineno-20-36" name="__codelineno-20-36" href="#__codelineno-20-36"></a>      )
<a id="__codelineno-20-37" name="__codelineno-20-37" href="#__codelineno-20-37"></a>    )
<a id="__codelineno-20-38" name="__codelineno-20-38" href="#__codelineno-20-38"></a>    (pooler): BertPooler(
<a id="__codelineno-20-39" name="__codelineno-20-39" href="#__codelineno-20-39"></a>      (dense): Linear(in_features=768, out_features=768, bias=True)
<a id="__codelineno-20-40" name="__codelineno-20-40" href="#__codelineno-20-40"></a>      (activation): Tanh()
<a id="__codelineno-20-41" name="__codelineno-20-41" href="#__codelineno-20-41"></a>    )
<a id="__codelineno-20-42" name="__codelineno-20-42" href="#__codelineno-20-42"></a>  )
<a id="__codelineno-20-43" name="__codelineno-20-43" href="#__codelineno-20-43"></a>  (seq): Sequential(
<a id="__codelineno-20-44" name="__codelineno-20-44" href="#__codelineno-20-44"></a>    (0): Linear(in_features=768, out_features=256, bias=True)
<a id="__codelineno-20-45" name="__codelineno-20-45" href="#__codelineno-20-45"></a>    (1): ReLU()
<a id="__codelineno-20-46" name="__codelineno-20-46" href="#__codelineno-20-46"></a>    (2): Linear(in_features=256, out_features=63, bias=True)
<a id="__codelineno-20-47" name="__codelineno-20-47" href="#__codelineno-20-47"></a>  )
<a id="__codelineno-20-48" name="__codelineno-20-48" href="#__codelineno-20-48"></a>)
</code></pre></div>
<h3 id="finding-ner-tags-in-a-document">Finding NER tags in a document<a class="headerlink" href="#finding-ner-tags-in-a-document" title="Permanent link">&para;</a></h3>
<p>We can use our model using something similar to the code below &amp; utilise the same <code>tokenizer</code>, the <code>parser</code> &amp; saved <code>model</code></p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-21-1" name="__codelineno-21-1" href="#__codelineno-21-1"></a><span class="k">def</span><span class="w"> </span><span class="nf">ner_inference</span><span class="p">(</span><span class="n">text</span><span class="p">,</span><span class="n">model</span><span class="p">):</span>
<a id="__codelineno-21-2" name="__codelineno-21-2" href="#__codelineno-21-2"></a>
<a id="__codelineno-21-3" name="__codelineno-21-3" href="#__codelineno-21-3"></a>    <span class="c1"># Tokenise input</span>
<a id="__codelineno-21-4" name="__codelineno-21-4" href="#__codelineno-21-4"></a>    <span class="n">tokenizer_output</span> <span class="o">=</span> <span class="n">tokenizer</span><span class="p">(</span><span class="n">text</span><span class="p">,</span>    
<a id="__codelineno-21-5" name="__codelineno-21-5" href="#__codelineno-21-5"></a>                                 <span class="n">padding</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> 
<a id="__codelineno-21-6" name="__codelineno-21-6" href="#__codelineno-21-6"></a>                                 <span class="n">truncation</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> 
<a id="__codelineno-21-7" name="__codelineno-21-7" href="#__codelineno-21-7"></a>                                 <span class="n">return_tensors</span><span class="o">=</span><span class="s1">&#39;pt&#39;</span><span class="p">)</span>
<a id="__codelineno-21-8" name="__codelineno-21-8" href="#__codelineno-21-8"></a>
<a id="__codelineno-21-9" name="__codelineno-21-9" href="#__codelineno-21-9"></a>    <span class="c1"># token word identifier (each word can have multiple tokens)</span>
<a id="__codelineno-21-10" name="__codelineno-21-10" href="#__codelineno-21-10"></a>    <span class="n">word_ids</span> <span class="o">=</span> <span class="n">tokenizer_output</span><span class="o">.</span><span class="n">word_ids</span><span class="p">()</span> 
<a id="__codelineno-21-11" name="__codelineno-21-11" href="#__codelineno-21-11"></a>
<a id="__codelineno-21-12" name="__codelineno-21-12" href="#__codelineno-21-12"></a>    <span class="c1"># for each word, how many subtokens are there (starts with 1 - first word)</span>
<a id="__codelineno-21-13" name="__codelineno-21-13" href="#__codelineno-21-13"></a>    <span class="n">subword_group</span> <span class="o">=</span> <span class="p">[</span>
<a id="__codelineno-21-14" name="__codelineno-21-14" href="#__codelineno-21-14"></a>        <span class="p">(</span><span class="n">key</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">group</span><span class="p">)))</span> 
<a id="__codelineno-21-15" name="__codelineno-21-15" href="#__codelineno-21-15"></a>        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">group</span> <span class="ow">in</span> <span class="n">itertools</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="n">word_ids</span><span class="p">)</span> 
<a id="__codelineno-21-16" name="__codelineno-21-16" href="#__codelineno-21-16"></a>            <span class="k">if</span> <span class="n">key</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
<a id="__codelineno-21-17" name="__codelineno-21-17" href="#__codelineno-21-17"></a>    <span class="p">]</span> <span class="c1"># index to aggregate tokens</span>
<a id="__codelineno-21-18" name="__codelineno-21-18" href="#__codelineno-21-18"></a>
<a id="__codelineno-21-19" name="__codelineno-21-19" href="#__codelineno-21-19"></a>    <span class="c1"># group all relevant data that will be used in forward pass </span>
<a id="__codelineno-21-20" name="__codelineno-21-20" href="#__codelineno-21-20"></a>    <span class="n">output</span> <span class="o">=</span> <span class="p">{</span>
<a id="__codelineno-21-21" name="__codelineno-21-21" href="#__codelineno-21-21"></a>        <span class="o">**</span><span class="n">tokenizer_output</span><span class="p">,</span>
<a id="__codelineno-21-22" name="__codelineno-21-22" href="#__codelineno-21-22"></a>        <span class="s2">&quot;subword_group&quot;</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">subword_group</span><span class="p">),</span>
<a id="__codelineno-21-23" name="__codelineno-21-23" href="#__codelineno-21-23"></a>    <span class="p">}</span>
<a id="__codelineno-21-24" name="__codelineno-21-24" href="#__codelineno-21-24"></a>
<a id="__codelineno-21-25" name="__codelineno-21-25" href="#__codelineno-21-25"></a>    <span class="c1"># get the highest logits value</span>
<a id="__codelineno-21-26" name="__codelineno-21-26" href="#__codelineno-21-26"></a>    <span class="n">tag_pred</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">model</span><span class="p">(</span><span class="n">output</span><span class="p">),</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
<a id="__codelineno-21-27" name="__codelineno-21-27" href="#__codelineno-21-27"></a>    <span class="n">tag_pred</span> 
<a id="__codelineno-21-28" name="__codelineno-21-28" href="#__codelineno-21-28"></a>
<a id="__codelineno-21-29" name="__codelineno-21-29" href="#__codelineno-21-29"></a>    <span class="k">return</span> <span class="n">tag_pred</span>
<a id="__codelineno-21-30" name="__codelineno-21-30" href="#__codelineno-21-30"></a>
<a id="__codelineno-21-31" name="__codelineno-21-31" href="#__codelineno-21-31"></a><span class="n">ner_inference</span><span class="p">(</span><span class="s1">&#39;В девять утра я улетаю в Зимбабве&#39;</span><span class="p">,</span><span class="n">new_model</span><span class="p">)</span>
</code></pre></div>
<p>The model predicts the following tags, which we can <strong>map</strong> using <code>parser.id_to_tag</code></p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-22-1" name="__codelineno-22-1" href="#__codelineno-22-1"></a>[0, 2, 0, 0, 0, 0, 0]
</code></pre></div>
<h4 id="references">REFERENCES<a class="headerlink" href="#references" title="Permanent link">&para;</a></h4>
<div class="footnote">
<hr />
<ol>
<li id="fn:footnote">
<p>https://www.mygreatlearning.com/blog/named-entity-recognition/#&#160;<a class="footnote-backref" href="#fnref:footnote" title="Jump back to footnote 1 in the text">&#8617;</a></p>
</li>
</ol>
</div>







  
  



  


  


  <form class="md-feedback" name="feedback" hidden>
    <fieldset>
      <legend class="md-feedback__title">
        Was this page helpful?
      </legend>
      <div class="md-feedback__inner">
        <div class="md-feedback__list">
          
            <button class="md-feedback__icon md-icon" type="submit" title="This page was helpful!" data-md-value="1">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M14 20h-4v-9l-3.5 3.5-2.42-2.42L12 4.16l7.92 7.92-2.42 2.42L14 11v9Z"/></svg>
            </button>
          
            <button class="md-feedback__icon md-icon" type="submit" title="This page could be improved!" data-md-value="0">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M10 4h4v9l3.5-3.5 2.42 2.42L12 19.84l-7.92-7.92L6.5 9.5 10 13V4Z"/></svg>
            </button>
          
        </div>
        <div class="md-feedback__note">
          
            <div data-md-value="1" hidden>
              
              
                
              
              Thanks for your feedback!
            </div>
          
            <div data-md-value="0" hidden>
              
              
                
              
              Thanks for your feedback!
            </div>
          
        </div>
      </div>
    </fieldset>
  </form>


      
    </article>
  </div>

          
  <script>var tabs=__md_get("__tabs");if(Array.isArray(tabs))e:for(var set of document.querySelectorAll(".tabbed-set")){var tab,labels=set.querySelector(".tabbed-labels");for(tab of tabs)for(var label of labels.getElementsByTagName("label"))if(label.innerText.trim()===tab){var input=document.getElementById(label.htmlFor);input.checked=!0;continue e}}</script>

<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
          <button type="button" class="md-top md-icon" data-md-component="top" hidden>
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8v12Z"/></svg>
  Back to top
</button>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
    <div class="md-copyright__highlight">
      Copyright &copy; 2023-2025 <a href="https://github.com/shtrausslearning"  target="_blank" rel="noopener">Andrey Shtrauss</a>

    </div>
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
        <div class="md-social">
  
    
    
    
    
    <a href="https://github.com/shtrausslearning" target="_blank" rel="noopener" title="shtrausslearning" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512"><!--! Font Awesome Free 6.5.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2023 Fonticons, Inc.--><path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6zm-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3zm44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9zM244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8zM97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1zm-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7zm32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1zm-11.4-14.7c-1.6 1-1.6 3.6 0 5.9 1.6 2.3 4.3 3.3 5.6 2.3 1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2z"/></svg>
    </a>
  
    
    
    
    
    <a href="https://www.kaggle/shtraussleaning" target="_blank" rel="noopener" title="shtrausslearning" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 320 512"><!--! Font Awesome Free 6.5.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2023 Fonticons, Inc.--><path d="M304.2 501.5 158.4 320.3 298.2 185c2.6-2.7 1.7-10.5-5.3-10.5h-69.2c-3.5 0-7 1.8-10.5 5.3L80.9 313.5V7.5q0-7.5-7.5-7.5H21.5Q14 0 14 7.5v497q0 7.5 7.5 7.5h51.9q7.5 0 7.5-7.5v-109l30.8-29.3 110.5 140.6c3 3.5 6.5 5.3 10.5 5.3h66.9q5.25 0 6-3z"/></svg>
    </a>
  
    
    
    
    
    <a href="https://t.me/mldsai_info" target="_blank" rel="noopener" title="mldsai-info" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512"><!--! Font Awesome Free 6.5.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2023 Fonticons, Inc.--><path d="M248 8C111.033 8 0 119.033 0 256s111.033 248 248 248 248-111.033 248-248S384.967 8 248 8Zm114.952 168.66c-3.732 39.215-19.881 134.378-28.1 178.3-3.476 18.584-10.322 24.816-16.948 25.425-14.4 1.326-25.338-9.517-39.287-18.661-21.827-14.308-34.158-23.215-55.346-37.177-24.485-16.135-8.612-25 5.342-39.5 3.652-3.793 67.107-61.51 68.335-66.746.153-.655.3-3.1-1.154-4.384s-3.59-.849-5.135-.5q-3.283.746-104.608 69.142-14.845 10.194-26.894 9.934c-8.855-.191-25.888-5.006-38.551-9.123-15.531-5.048-27.875-7.717-26.8-16.291q.84-6.7 18.45-13.7 108.446-47.248 144.628-62.3c68.872-28.647 83.183-33.623 92.511-33.789 2.052-.034 6.639.474 9.61 2.885a10.452 10.452 0 0 1 3.53 6.716 43.765 43.765 0 0 1 .417 9.769Z"/></svg>
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    <script id="__config" type="application/json">{"base": "../../../..", "features": ["header.autohide", "content.code.annotate", "content.code.copy", "content.code.select", "content.tabs.link", "content.tooltips", "navigation.indexes", "navigation.path", "navigation.tabs", "navigation.top", "search.highlight", "search.suggest", "navigation.sections"], "search": "../../../../assets/javascripts/workers/search.b8dbb3d2.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}}</script>
    
    
      <script src="../../../../assets/javascripts/bundle.1e8ae164.min.js"></script>
      
        <script src="../../../../javascripts/katex.js"></script>
      
        <script src="../../../../javascripts/extra.js"></script>
      
        <script src="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.16.7/katex.min.js"></script>
      
        <script src="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.16.7/contrib/auto-render.min.js"></script>
      
    
  </body>
</html>